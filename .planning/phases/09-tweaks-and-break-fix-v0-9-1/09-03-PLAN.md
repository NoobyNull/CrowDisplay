---
phase: 9
plan: 3
title: "Configurable Stats Header with TLV Protocol"
depends_on: []
---

# Plan 09-03: TLV Stats Protocol + Dynamic Stats Header

## Goal
Replace fixed 8-stat header with user-configurable, placeable stats (up to 20 types) using TLV protocol encoding, with selectable monitor types and user-defined display order.

## Context
Current implementation sends fixed `StatsPayload` struct (10 bytes) with hardcoded stats. Display renders them in a hardcoded 2-row layout with fixed positions. This plan migrates to Type-Length-Value encoding for flexible stat selection and adds user-configurable stat positioning (order in header driven by config).

**Files affected:**
- `shared/protocol.h` - Add StatType enum, TLV decoding helper
- `display/config.h` - Add StatConfig struct, stats_header vector
- `display/config.cpp` - Parse stats_header from JSON with defaults
- `display/ui.cpp` - Dynamic stats header from config, TLV decoding
- `companion/hotkey_companion.py` - TLV stats encoding, read stats config
- `companion/ui/editor_main.py` - Stats header config panel
- `companion/config_manager.py` - Stats schema validation

## Tasks

<task id="1">
<title>Define TLV stats protocol and StatType enum</title>
<files>shared/protocol.h</files>
<action>
1. Add `StatType` enum for expanded monitor types:
   ```cpp
   enum StatType : uint8_t {
       STAT_CPU_PERCENT    = 0x01,
       STAT_RAM_PERCENT    = 0x02,
       STAT_GPU_PERCENT    = 0x03,
       STAT_CPU_TEMP       = 0x04,
       STAT_GPU_TEMP       = 0x05,
       STAT_DISK_PERCENT   = 0x06,
       STAT_NET_UP         = 0x07,
       STAT_NET_DOWN       = 0x08,
       STAT_CPU_FREQ       = 0x09,  // MHz, uint16
       STAT_GPU_FREQ       = 0x0A,  // MHz, uint16
       STAT_SWAP_PERCENT   = 0x0B,
       STAT_UPTIME_HOURS   = 0x0C,  // Hours, uint16
       STAT_BATTERY_PCT    = 0x0D,  // For laptops
       STAT_FAN_RPM        = 0x0E,  // uint16
       STAT_LOAD_AVG       = 0x0F,  // Load average × 100, uint16
       STAT_PROC_COUNT     = 0x10,  // Process count, uint16
       STAT_GPU_MEM_PCT    = 0x11,  // GPU memory percent
       STAT_GPU_POWER_W    = 0x12,  // GPU power in watts
       STAT_DISK_READ_KBS  = 0x13,  // Disk read KB/s, uint16
       STAT_DISK_WRITE_KBS = 0x14,  // Disk write KB/s, uint16
   };
   ```

2. Keep existing `StatsPayload` struct for backwards compatibility but mark as deprecated. New `MSG_STATS` payloads use TLV format (detected by first-byte heuristic: if data[0] <= 20, it's TLV count; if data[0] > 20, it's old cpu_percent).

3. Add TLV decoding helper (inline function):
   ```cpp
   inline bool tlv_decode_stats(const uint8_t *data, uint8_t len,
                                 void (*callback)(uint8_t type, uint16_t value)) {
       if (len < 1) return false;
       uint8_t count = data[0];
       uint8_t pos = 1;
       for (uint8_t i = 0; i < count && pos < len - 1; i++) {
           uint8_t type = data[pos++];
           uint8_t vlen = data[pos++];
           if (pos + vlen > len) return false;
           uint16_t value = 0;
           if (vlen == 1) value = data[pos];
           else if (vlen == 2) value = data[pos] | (data[pos+1] << 8);
           else return false;
           callback(type, value);
           pos += vlen;
       }
       return true;
   }
   ```
</action>
<verify>
1. Build display firmware: `pio run -e running`
2. Build bridge firmware: `pio run -e bridge`
3. Verify StatType enum values are sequential and documented
4. Check protocol.h compiles without errors
</verify>
<done>protocol.h defines StatType enum (20 types) and tlv_decode_stats helper. Backwards compatible with old StatsPayload.</done>
</task>

<task id="2">
<title>Add stats header config to schema and implement TLV encoding in companion</title>
<files>display/config.h, display/config.cpp, companion/hotkey_companion.py</files>
<action>
1. In `display/config.h`, add StatConfig and stats_header to AppConfig:
   ```cpp
   struct StatConfig {
       uint8_t type;      // StatType enum value
       uint32_t color;    // Display color (RGB hex)
       uint8_t position;  // Display order (0-based, left-to-right then row wrap)
   };

   struct AppConfig {
       // ... existing fields
       std::vector<StatConfig> stats_header;  // User-selected stats (default 8)
   };
   ```

2. In `display/config.cpp`, parse stats_header from JSON with defaults:
   ```cpp
   // Default stats (if not in JSON): matches current hardcoded 8
   if (doc["stats_header"].isNull()) {
       cfg.stats_header = {
           {STAT_CPU_PERCENT, 0x3498DB, 0},
           {STAT_RAM_PERCENT, 0x2ECC71, 1},
           {STAT_GPU_PERCENT, 0xE67E22, 2},
           {STAT_CPU_TEMP,    0xE74C3C, 3},
           {STAT_GPU_TEMP,    0xF1C40F, 4},
           {STAT_NET_UP,      0x1ABC9C, 5},
           {STAT_NET_DOWN,    0x1ABC9C, 6},
           {STAT_DISK_PERCENT,0x7F8C8D, 7},
       };
   } else {
       // Parse from JSON array
       for (JsonObject stat_obj : doc["stats_header"].as<JsonArray>()) {
           StatConfig stat;
           stat.type = stat_obj["type"] | 0;
           stat.color = stat_obj["color"] | 0xFFFFFF;
           stat.position = stat_obj["position"] | 0;
           cfg.stats_header.push_back(stat);
       }
   }
   ```
   Serialize in config_save() as well.

3. In `companion/hotkey_companion.py`, add TLV encoding:
   ```python
   STAT_TYPES = {
       'cpu_percent': 0x01, 'ram_percent': 0x02, 'gpu_percent': 0x03,
       'cpu_temp': 0x04, 'gpu_temp': 0x05, 'disk_percent': 0x06,
       'net_up': 0x07, 'net_down': 0x08, 'cpu_freq': 0x09,
       'gpu_freq': 0x0A, 'swap_percent': 0x0B, 'uptime_hours': 0x0C,
       'battery_pct': 0x0D, 'fan_rpm': 0x0E, 'load_avg': 0x0F,
       'proc_count': 0x10, 'gpu_mem_pct': 0x11, 'gpu_power_w': 0x12,
       'disk_read_kbs': 0x13, 'disk_write_kbs': 0x14,
   }

   def encode_stats_tlv(stats_list):
       packet = bytearray([len(stats_list)])
       for stat_type, value in stats_list:
           packet.append(stat_type)
           if value < 256:
               packet.append(1)
               packet.append(value & 0xFF)
           else:
               packet.append(2)
               packet.extend(struct.pack('<H', value & 0xFFFF))
       return bytes(packet)
   ```

4. Read stats_header config from config.json to know which stats to collect and send. Only collect enabled stats (saves CPU on unused psutil calls).

5. Add new collection functions for expanded stats: swap%, CPU freq, GPU memory, GPU power, disk I/O, load average, process count, uptime, fan RPM, battery.
</action>
<verify>
1. Build firmware with StatConfig in config.h
2. Run companion, verify TLV encoding in logs
3. Load config with custom stats_header, verify parsing
4. Load v0.9.0 config (no stats_header), verify defaults applied
</verify>
<done>StatConfig struct added. Config parses stats_header from JSON with defaults matching current 8 stats. Companion encodes TLV and collects expanded stats based on config.</done>
</task>

<task id="3">
<title>Implement dynamic stats header rendering with TLV decoding on display</title>
<files>display/ui.cpp</files>
<action>
1. Replace hardcoded `create_stats_header()` with config-driven version:
   ```cpp
   static void create_stats_header(lv_obj_t *parent, const AppConfig *cfg) {
       // Create header container (same as before)
       stats_header = lv_obj_create(parent);
       lv_obj_set_size(stats_header, SCREEN_WIDTH, 90);
       // ... same styling as before

       // Create labels from config, sorted by position
       // Split into 2 rows: positions 0-4 in row1, 5-7 in row2
       for (const auto& stat : cfg->stats_header) {
           if (stat.position >= 8) continue;
           lv_obj_t *parent_row = (stat.position < 5) ? row1 : row2;
           stat_labels[stat.position] = create_stat_label(parent_row, "---", stat.color);
       }
   }
   ```

2. Update `update_stats()` to decode TLV instead of fixed struct:
   ```cpp
   void update_stats(const uint8_t *data, uint8_t len) {
       // Detect TLV vs legacy format
       if (len >= sizeof(StatsPayload) && data[0] > 20) {
           // Legacy fixed format (backwards compat)
           update_stats_legacy((const StatsPayload*)data);
           return;
       }
       // TLV format
       tlv_decode_stats(data, len, update_stat_widget);
   }
   ```

3. Implement `update_stat_widget()` callback that maps StatType to the correct label position using the config's stats_header vector. Format values based on type (percent, temperature, KB/s, MHz, hours).

4. Add `get_stat_name()` helper returning display prefix for each StatType.

5. Pass `const AppConfig *cfg` to `create_stats_header()` from `create_ui_widgets()`.
</action>
<verify>
1. Flash firmware
2. Send TLV stats from companion
3. Verify stats header shows decoded values at config-specified positions with config-specified colors
4. Test with only 4 stats configured — verify only 4 labels shown
5. Send legacy StatsPayload — verify backwards compatibility works
</verify>
<done>Stats header renders dynamically from config. TLV decoding maps stats to positioned, colored labels. Legacy StatsPayload still supported.</done>
</task>

<task id="4">
<title>Add stats header configuration panel to editor</title>
<files>companion/ui/editor_main.py, companion/config_manager.py</files>
<action>
1. Add "Stats Header" config panel to editor (new tab or section):
   - Table widget showing selected stats (up to 8 rows)
   - Columns: Position (display order), Type (dropdown of all StatType names), Color (color picker)
   - Dropdown populates from StatType names: "CPU %", "RAM %", "GPU %", "CPU Temp", "GPU Temp", "Disk %", "Net Up", "Net Down", "CPU Freq", "GPU Freq", "Swap %", "Uptime", "Battery", "Fan RPM", etc.
   - Drag-and-drop rows to reorder position (position = row index in table)
   - Add/Remove buttons to adjust stat count (1-8 stats)

2. Wire stats panel to config save/load:
   ```python
   config["stats_header"] = [
       {"type": stat_type_id, "color": color_int, "position": row_index}
       for row_index, (stat_type_id, color_int) in enumerate(stats_table_rows)
   ]
   ```

3. Add schema validation in `companion/config_manager.py`:
   - stats_header is array of {type: int, color: int, position: int}
   - Max 8 entries, position 0-7, type 1-20
   - No duplicate positions

4. Show live preview of header layout in editor (horizontal bar with colored labels).
</action>
<verify>
1. Run editor, open Stats Header tab
2. Change stat type from "CPU %" to "CPU Freq", change color
3. Reorder by dragging rows
4. Save config, verify JSON has correct stats_header array
5. Upload to display, verify stats header matches editor config
</verify>
<done>Editor has Stats Header config panel with type dropdown, color picker, drag-to-reorder. Config validates stats_header schema.</done>
</task>

## Verification

**TLV stats protocol:**
1. Send TLV-encoded stats from companion with 8 stats
2. Display decodes and shows all 8 stats in header
3. Send partial stats (only 4 types), verify other labels show "---"
4. Check payload size: 8 stats × 3 bytes = ~24 bytes (well under 250-byte limit)

**Dynamic stats header:**
1. Configure stats header in editor: CPU%, GPU Freq, Uptime, Battery%
2. Upload config, verify display shows selected stats in correct order
3. Change stat positions via drag-reorder, verify display updates
4. Test with 4 stats vs 8 stats, verify layout adjusts

**Expanded stat types:**
1. Enable CPU Freq, Swap%, GPU Memory in stats config
2. Verify companion collects these via psutil/pynvml
3. Verify display shows formatted values (MHz, %, etc.)

**Backwards compatibility:**
1. Load v0.9.0 config (no stats_header)
2. Verify defaults to original 8 hardcoded stats
3. Send legacy StatsPayload, verify display handles it

## Success Criteria

- [ ] protocol.h defines StatType enum (20 types) and tlv_decode_stats helper
- [ ] StatConfig struct in config.h with type, color, position fields
- [ ] Config parses stats_header from JSON with defaults matching current 8 stats
- [ ] Companion encodes stats as TLV (3 bytes per stat)
- [ ] Companion collects expanded stats based on config (only enabled types)
- [ ] Display decodes TLV and updates dynamic header at config-specified positions
- [ ] Legacy StatsPayload backwards compatible
- [ ] Editor has Stats Header config panel with type/color/reorder
- [ ] Config validates stats_header schema (no duplicate positions, valid types)
- [ ] v0.9.0 configs load with default stats header
