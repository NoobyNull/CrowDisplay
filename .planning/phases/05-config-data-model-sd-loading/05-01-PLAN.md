---
phase: 05-config-data-model-sd-loading
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - platformio.ini
  - display/config.h
  - display/config.cpp
  - display/config_server.cpp
autonomous: true

must_haves:
  truths:
    - "Device boots and loads hotkey layout from /config.json on SD card with pages, buttons, labels, key bindings, colors, icons, and media key consumer codes"
    - "Device boots to usable default hotkey layout when SD card is missing, config file is absent, or JSON is malformed"
    - "Config file includes a version field (version: 1) and the device can distinguish config format versions"
    - "When config is saved, previous config.json is backed up to config.json.bak before overwrite"
    - "Config writes use atomic temp-file-then-rename pattern to prevent corruption on power loss"
  artifacts:
    - path: "platformio.ini"
      provides: "ArduinoJson v7 dependency for display env"
      contains: "bblanchon/ArduinoJson"
    - path: "display/config.h"
      provides: "AppConfig struct with version field, JSON I/O API"
      contains: "uint8_t version"
    - path: "display/config.cpp"
      provides: "JSON parse/serialize with PSRAM allocator, atomic save with backup, defaults fallback"
      contains: "config.json.bak"
  key_links:
    - from: "display/config.cpp"
      to: "display/sdcard.h"
      via: "sdcard_read_file, sdcard_write_file, sdcard_file_rename"
      pattern: "sdcard_file_rename"
    - from: "display/main.cpp"
      to: "display/config.h"
      via: "config_load() called before create_ui()"
      pattern: "config_load"
---

<objective>
Finalize the config data model and SD card persistence layer for Phase 5: add ArduinoJson v7 dependency, migrate JSON parsing from v6 StaticJsonDocument (stack-allocated, internal SRAM) to v7 JsonDocument with PSRAM allocator, add config version field (CFG-06), implement backup-before-overwrite (CFG-07), and fix atomic save with temp-file-then-rename (CFG-08).

Purpose: The existing config.cpp/h already implements most of the config system (AppConfig struct, JSON parse/serialize, defaults fallback, SD load/save) but has five specific gaps against Phase 5 requirements: ArduinoJson is not in platformio.ini lib_deps (won't compile from clean checkout), the code uses v6 API (StaticJsonDocument on stack, consuming internal SRAM), there is no version field in the schema, config_save() doesn't backup the old file, and config_save() has a TODO for atomic rename but writes directly instead.

Output: Compilable config system that satisfies all CFG-01 through CFG-08 requirements.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/SUMMARY.md

@display/config.h
@display/config.cpp
@display/config_server.cpp
@display/sdcard.h
@display/sdcard.cpp
@display/main.cpp
@platformio.ini
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ArduinoJson v7 and migrate config.cpp/h to v7 API with PSRAM allocator</name>
  <files>platformio.ini, display/config.h, display/config.cpp</files>
  <action>
1. **platformio.ini**: Add `bblanchon/ArduinoJson@^7.4.0` to `[env:display]` lib_deps (after the SparkFun library line).

2. **display/config.h**: Add a `uint8_t version` field to AppConfig struct, initialized to 1 in the constructor. This satisfies CFG-06 (config schema includes version field for future format migration). Also add a `#define CONFIG_VERSION 1` constant at the top of the file.

3. **display/config.cpp** -- Migrate from ArduinoJson v6 to v7 API:
   - In `config_load()`:
     - Replace the `static uint8_t buffer[64 * 1024]` stack allocation with a PSRAM-allocated buffer: `uint8_t *buffer = (uint8_t *)ps_malloc(64 * 1024)`. Free it before every return path. This moves 64KB off the stack/internal SRAM into PSRAM per the research recommendation.
     - Replace `StaticJsonDocument<16 * 1024> doc` with `JsonDocument doc` (ArduinoJson v7 auto-sizes, no Static/Dynamic distinction).
     - After successful parse, read `doc["version"]` and store in `cfg.version`. Log a warning if version != CONFIG_VERSION but still load the config (forward compatibility).
     - Replace v6 `doc.containsKey("foo")` with v7 null-check pattern: `if (!doc["foo"].isNull())`. ArduinoJson v7 deprecated containsKey.
     - Replace v6 `doc.createNestedArray("key")` / `doc.createNestedObject()` calls with v7 `doc["key"].to<JsonArray>()` / `arr.add<JsonObject>()` syntax.
   - In `config_save()`:
     - Replace `StaticJsonDocument<16 * 1024> doc` with `JsonDocument doc`.
     - Add `doc["version"] = CONFIG_VERSION` to serialize the version field.
     - Replace v6 nested array/object creation with v7 API (same pattern as load).
   - In all helper functions (button_to_json, json_to_button, page_to_json, json_to_page, profile_to_json, json_to_profile):
     - Replace `obj.containsKey("key")` with `!obj["key"].isNull()`.
     - Replace `obj.createNestedArray("key")` with `obj["key"].to<JsonArray>()`.
     - Replace `array.createNestedObject()` with `array.add<JsonObject>()`.

4. **display/config_server.cpp** -- Same v6-to-v7 migration:
   - In `handle_config_upload()` at UPLOAD_FILE_END:
     - Replace both `StaticJsonDocument<65536> doc` and `StaticJsonDocument<65536> validate_doc` with `JsonDocument doc` and `JsonDocument validate_doc`.
     - Use `ps_malloc()` instead of `malloc()` for the config_buffer allocation in UPLOAD_FILE_START (line 138).
     - Remove the redundant `uint8_t validate_buf[65536]` stack array -- instead, re-parse directly from the buffer already in memory (config_buffer).

**ArduinoJson v7 API quick reference (do NOT use v6 patterns):**
- `JsonDocument doc;` (no template size, no Static/Dynamic prefix)
- `doc["key"].to<JsonArray>()` replaces `doc.createNestedArray("key")`
- `arr.add<JsonObject>()` replaces `arr.createNestedObject()`
- `!doc["key"].isNull()` replaces `doc.containsKey("key")`
- `doc["key"].as<T>()` unchanged
- `serializeJson(doc, str)` unchanged
- `deserializeJson(doc, buffer)` unchanged
  </action>
  <verify>Run `cd /data/Elcrow-Display-hotkeys && pio run -e display 2>&1 | tail -20` -- must compile cleanly with no ArduinoJson errors. Verify the version field appears in serial output by grepping: `grep -n "version" display/config.cpp` should show version read/write logic.</verify>
  <done>ArduinoJson v7 in lib_deps, all config.cpp and config_server.cpp code uses v7 API (no StaticJsonDocument, no createNestedArray, no containsKey), PSRAM allocation for parse buffers, version field in AppConfig struct and JSON schema.</done>
</task>

<task type="auto">
  <name>Task 2: Implement backup-before-overwrite and atomic save pattern in config_save()</name>
  <files>display/config.cpp</files>
  <action>
Fix config_save() to satisfy CFG-07 (auto-backup) and CFG-08 (atomic write):

1. **Backup before overwrite (CFG-07):** At the start of config_save(), before writing anything, check if `/config.json` exists on SD card. If it does, copy it to `/config.json.bak` using sdcard_read_file + sdcard_write_file. Log "CONFIG: backed up /config.json to /config.json.bak". If backup fails, log warning but continue (don't block save on backup failure).

2. **Atomic write pattern (CFG-08):** Replace the current double-write pattern (which writes to both /config.tmp AND /config.json directly) with the correct atomic pattern:
   - Write JSON to `/config.tmp` using sdcard_write_file()
   - If write succeeds, remove old `/config.json` if it exists (SD library's remove)
   - Rename `/config.tmp` to `/config.json` using sdcard_file_rename()
   - If rename fails, log error and return false
   - Remove the redundant second sdcard_write_file("/config.json", ...) call and the TODO comment

3. **Add sdcard_file_remove() to sdcard.h/cpp** if not already present -- needed to remove old config.json before rename (some FAT implementations require target not to exist for rename). Check if SD.remove() is available. If sdcard_file_rename already handles overwrite (Arduino SD rename may overwrite), then skip the explicit remove step and just rename directly.

4. **Validation:** After the atomic rename, read back the file and verify it parses. If verification fails, restore from backup. This provides crash safety: if power is lost during write, either the old config.json or config.json.bak survives.
  </action>
  <verify>Grep config_save in display/config.cpp for the backup and rename logic: `grep -A 30 'config_save' display/config.cpp` should show config.json.bak copy, /config.tmp write, and sdcard_file_rename call with no direct write to /config.json. Run `pio run -e display 2>&1 | tail -5` to confirm clean compilation.</verify>
  <done>config_save() backs up existing config.json to config.json.bak before overwrite, writes atomically via temp file then rename, no direct write to /config.json. Compilation succeeds.</done>
</task>

<task type="auto">
  <name>Task 3: Add page count validation and comprehensive serial logging for config load diagnostics</name>
  <files>display/config.cpp, display/config.h</files>
  <action>
1. **Page count validation (CFG-03):** In config_load(), after deserializing the active profile, validate that the page count is between 1 and 16 (inclusive). Add `#define CONFIG_MAX_PAGES 16` to config.h. If a profile has 0 pages or more than 16, log a warning and fall back to defaults. Similarly, if any page has 0 buttons or more than 16 buttons, log a warning about that specific page but don't reject the entire config (just skip that page or truncate to 16 buttons).

2. **Version check logging:** In config_load(), after reading the version field, log: "CONFIG: schema version %d (expected %d)". If version > CONFIG_VERSION, log "CONFIG: WARNING - config was created by a newer version, some fields may be ignored". If version < CONFIG_VERSION, log "CONFIG: NOTE - older config format, will be upgraded on next save". Do NOT reject configs based on version -- this is informational for future migration support.

3. **Load summary logging:** At the end of successful config_load(), print a summary: "CONFIG: Loaded '%s' - %d pages, %d total buttons, version %d". Count total buttons across all pages of the active profile. This helps with debugging config issues over serial.

4. **Defaults logging:** In config_create_defaults(), set version = CONFIG_VERSION on the returned config. Ensure the default config would serialize correctly by verifying all fields have sensible values.

5. **config_init() cleanup:** The existing config_init() function caches defaults into a static global but is never called from main.cpp. Either remove it or call it from setup(). Since config_load() already calls config_create_defaults() on failure, config_init() is redundant. Remove it and the associated static globals (g_default_config, g_default_config_initialized) to avoid dead code.
  </action>
  <verify>Run `pio run -e display 2>&1 | tail -5` to confirm compilation. Grep for the validation logic: `grep -n "CONFIG_MAX_PAGES\|version\|total buttons" display/config.cpp display/config.h` should show the validation and logging code.</verify>
  <done>Config load validates page count (1-16 per CFG-03), logs version compatibility info, prints load summary with page/button counts, dead code removed. Full compilation succeeds with all Phase 5 requirements satisfied.</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `pio run -e display` compiles cleanly (no warnings from config.cpp or config_server.cpp)
2. `grep -c "StaticJsonDocument\|DynamicJsonDocument" display/config.cpp display/config_server.cpp` returns 0 (all v6 API removed)
3. `grep "ArduinoJson" platformio.ini` shows the v7 dependency
4. `grep "version" display/config.h` shows the version field in AppConfig
5. `grep "config.json.bak" display/config.cpp` shows backup logic
6. `grep "config.tmp" display/config.cpp` shows atomic write pattern
7. `grep "CONFIG_MAX_PAGES" display/config.h` shows page count limit
8. All 8 CFG requirements are addressed:
   - CFG-01: JSON config on SD, loaded at boot (existing, now compiles)
   - CFG-02: Per-button config with label, binding, color, icon, type, consumer code (existing struct)
   - CFG-03: Variable pages 1-16 with validation
   - CFG-04: Media keys as consumer codes (existing in struct)
   - CFG-05: Fallback to defaults on missing/corrupt (existing logic)
   - CFG-06: Version field in schema
   - CFG-07: Auto-backup to config.json.bak
   - CFG-08: Atomic temp-file-then-rename write
</verification>

<success_criteria>
- Display firmware compiles cleanly with ArduinoJson v7
- Config system uses PSRAM for JSON parsing buffers (no 64KB stack allocations)
- AppConfig struct includes version field, serialized to/from JSON
- config_save() creates config.json.bak backup and uses atomic write
- Page count validated to 1-16 range
- All code uses ArduinoJson v7 API (no v6 remnants)
</success_criteria>

<output>
After completion, create `.planning/phases/05-config-data-model-sd-loading/05-01-SUMMARY.md`
</output>
