---
phase: 07-config-server-softap-http
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - display/ui.cpp
  - display/ui.h
autonomous: true

must_haves:
  truths:
    - "User taps a gear icon in the header bar and the display enters config mode, showing SSID, password, and IP address on a dedicated screen"
    - "Config mode screen has an 'Apply & Exit' button that stops SoftAP and returns to the main hotkey view"
    - "If SoftAP times out (5 min inactivity), the display automatically returns from config screen to main view"
    - "OTA button and OTA screen are replaced by config button and config screen (single mode for all wireless management)"
    - "Config upload URL and OTA firmware URL are both shown on the config mode screen"
  artifacts:
    - path: "display/ui.cpp"
      provides: "Config mode screen with SSID/pass/IP display, config icon in header, Apply & Exit button"
      contains: "config_screen"
    - path: "display/ui.h"
      provides: "show_config_screen and hide_config_screen declarations"
      contains: "show_config_screen"
  key_links:
    - from: "display/ui.cpp"
      to: "display/config_server.h"
      via: "config_server_start/stop called from UI event callbacks"
      pattern: "config_server_start"
    - from: "display/main.cpp"
      to: "display/ui.h"
      via: "hide_config_screen called on timeout"
      pattern: "hide_config_screen"
---

<objective>
Replace the OTA button and OTA screen with a unified config mode button (gear icon) and config mode screen showing WiFi credentials and upload URLs. Wire the UI to config_server_start/stop and handle inactivity timeout screen transitions.

Purpose: Provide the user-facing interface for entering config mode (WIFI-01, WIFI-04), exiting via "Apply & Exit" (WIFI-05), and displaying connection info.
Output: Config mode screen in ui.cpp, header config icon, show/hide functions in ui.h.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-config-server-softap-http/07-RESEARCH.md
@.planning/phases/07-config-server-softap-http/07-01-SUMMARY.md
@display/ui.cpp
@display/ui.h
@display/config_server.h
@display/main.cpp
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace OTA screen/button with config mode screen/button in ui.cpp</name>
  <files>
    display/ui.cpp
    display/ui.h
  </files>
  <action>
**ui.h changes:**
- Remove `show_ota_screen` and `hide_ota_screen` declarations
- Add declarations:
  ```cpp
  void show_config_screen();   // Enter config mode screen
  void hide_config_screen();   // Return to main hotkey view from config screen
  ```

**ui.cpp changes:**

1. **Replace OTA includes and state with config equivalents:**
   - Remove `#include "ota.h"` (no longer exists)
   - Add `#include "config_server.h"` if not already included
   - Replace OTA screen state variables:
     ```cpp
     // Config mode screen (replaces OTA screen)
     static lv_obj_t *config_screen = nullptr;
     static lv_obj_t *config_info_label = nullptr;
     ```
   - Remove `ota_screen` and `ota_ip_label` variables

2. **Replace `ota_btn_event_cb` with `config_btn_event_cb`:**
   ```cpp
   static void config_btn_event_cb(lv_event_t *e) {
       lv_event_code_t code = lv_event_get_code(e);
       if (code == LV_EVENT_CLICKED) {
           if (!config_server_active()) {
               if (config_server_start()) {
                   show_config_screen();
               }
           } else {
               config_server_stop();
               hide_config_screen();
           }
       }
   }
   ```

3. **Replace `show_ota_screen` with `show_config_screen`:**
   ```cpp
   void show_config_screen() {
       if (!config_screen) return;
       if (config_info_label) {
           IPAddress ip = WiFi.softAPIP();
           lv_label_set_text_fmt(config_info_label,
               "Connect to WiFi:\n"
               "  SSID: CrowPanel-Config\n"
               "  Password: crowconfig\n\n"
               "Config upload:\n"
               "  http://%s\n\n"
               "OTA firmware upload:\n"
               "  http://%s/update\n\n"
               "PlatformIO:\n"
               "  pio run -t upload --upload-port %s",
               ip.toString().c_str(), ip.toString().c_str(), ip.toString().c_str());
       }
       lv_scr_load(config_screen);
   }
   ```

4. **Replace `hide_ota_screen` with `hide_config_screen`:**
   ```cpp
   void hide_config_screen() {
       if (main_screen) {
           lv_scr_load(main_screen);
       }
   }
   ```

5. **In `create_ui_widgets()` header section**, replace the OTA button with config button:
   - Change the icon from `LV_SYMBOL_DOWNLOAD` to `LV_SYMBOL_SETTINGS` (gear icon)
   - Change variable name from `ota_btn` to `cfg_btn`
   - Change color to `CLR_TEAL` (0x1ABC9C) to distinguish from other icons
   - Change event callback from `ota_btn_event_cb` to `config_btn_event_cb`
   - Keep same position: `LV_ALIGN_RIGHT_MID, -55, 0`

6. **In `create_ui()`, replace the OTA screen creation block** (lines 505-531) with config mode screen:
   ```cpp
   // --- Config mode screen (created once, persists across rebuilds) ---
   config_screen = lv_obj_create(NULL);
   lv_obj_set_style_bg_color(config_screen, lv_color_hex(0x0d1b2a), LV_PART_MAIN);
   lv_obj_set_style_bg_opa(config_screen, LV_OPA_COVER, LV_PART_MAIN);

   lv_obj_t *cfg_title = lv_label_create(config_screen);
   lv_label_set_text(cfg_title, LV_SYMBOL_SETTINGS "  Config Upload Mode");
   lv_obj_set_style_text_font(cfg_title, &lv_font_montserrat_28, LV_PART_MAIN);
   lv_obj_set_style_text_color(cfg_title, lv_color_hex(CLR_TEAL), LV_PART_MAIN);
   lv_obj_align(cfg_title, LV_ALIGN_TOP_MID, 0, 40);

   config_info_label = lv_label_create(config_screen);
   lv_label_set_text(config_info_label, "Starting...");
   lv_obj_set_style_text_font(config_info_label, &lv_font_montserrat_18, LV_PART_MAIN);
   lv_obj_set_style_text_color(config_info_label, lv_color_white(), LV_PART_MAIN);
   lv_obj_set_style_text_align(config_info_label, LV_TEXT_ALIGN_LEFT, LV_PART_MAIN);
   lv_obj_align(config_info_label, LV_ALIGN_CENTER, 0, 10);

   // "Apply & Exit" button
   lv_obj_t *cfg_exit = lv_btn_create(config_screen);
   lv_obj_set_size(cfg_exit, 250, 50);
   lv_obj_align(cfg_exit, LV_ALIGN_BOTTOM_MID, 0, -40);
   lv_obj_set_style_bg_color(cfg_exit, lv_color_hex(CLR_GREEN), LV_PART_MAIN);
   lv_obj_add_event_cb(cfg_exit, config_btn_event_cb, LV_EVENT_CLICKED, nullptr);
   lv_obj_t *exit_lbl = lv_label_create(cfg_exit);
   lv_label_set_text(exit_lbl, "Apply & Exit");
   lv_obj_center(exit_lbl);
   ```

7. **Remove all remaining `ota_screen`/`ota_ip_label` references**, including forward declarations of `show_ota_screen`/`hide_ota_screen`.

8. **Remove the `show_ota_screen` and `hide_ota_screen` function implementations** entirely (replaced by config equivalents).
  </action>
  <verify>
Run `cd /data/Elcrow-Display-hotkeys && pio run -e display 2>&1 | tail -20` -- display compiles cleanly.
Grep for `ota_screen\|ota_ip_label\|show_ota_screen\|hide_ota_screen\|ota_btn_event_cb` in ui.cpp -- should return zero matches.
Grep for `config_screen` in ui.cpp -- should show config screen creation and show/hide functions.
Grep for `LV_SYMBOL_SETTINGS` in ui.cpp -- should appear in header button and config screen title.
Grep for `config_server_start\|config_server_stop` in ui.cpp -- should appear in config_btn_event_cb.
  </verify>
  <done>
Config mode screen replaces OTA screen: gear icon (LV_SYMBOL_SETTINGS) in header triggers config_server_start(), loads config screen showing SSID/password/IP/URLs. "Apply & Exit" button calls config_server_stop() and returns to main view. No OTA-specific UI remains.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire config screen timeout handling in main.cpp</name>
  <files>
    display/main.cpp
  </files>
  <action>
1. **Update main.cpp** to handle config server inactivity timeout screen return:
   - The config_server_timed_out() check added in Plan 01 Task 2 should now call `hide_config_screen()`:
     ```cpp
     // Handle config server inactivity timeout (auto-stopped, return to main view)
     if (config_server_timed_out()) {
         Serial.println("Config server: timed out, returning to main view");
         hide_config_screen();
     }
     ```
   - Note: `hide_config_screen()` is declared in ui.h (already included) and implemented in ui.cpp from Task 1.

2. **Verify** that `#include "ui.h"` is present in main.cpp (it already is at line 7).

3. **Verify** that no references to `ota.h`, `ota_start()`, `ota_stop()`, `ota_poll()`, or `ota_active()` remain anywhere in ui.cpp or main.cpp.
  </action>
  <verify>
Run `cd /data/Elcrow-Display-hotkeys && pio run -e display 2>&1 | tail -20` -- compiles cleanly.
Grep for `hide_config_screen` in main.cpp -- should appear in timeout handler.
Grep for `ota_` in display/main.cpp display/ui.cpp -- should return zero matches.
  </verify>
  <done>
Inactivity timeout correctly triggers hide_config_screen() from main loop, returning the display to the hotkey view after 5 minutes of no activity. No OTA references remain in any display source file.
  </done>
</task>

</tasks>

<verification>
1. `pio run -e display` compiles with zero errors
2. `grep -r "ota_start\|ota_stop\|ota_poll\|ota_active\|ota_screen\|ota_ip_label" display/ui.cpp display/main.cpp` returns no matches
3. `grep "config_screen" display/ui.cpp` shows config screen creation and management
4. `grep "LV_SYMBOL_SETTINGS" display/ui.cpp` shows gear icon in header and config screen title
5. `grep "hide_config_screen" display/main.cpp` shows timeout handling
6. `grep "Apply.*Exit" display/ui.cpp` shows exit button text
</verification>

<success_criteria>
- Gear icon (LV_SYMBOL_SETTINGS) in header replaces OTA download icon
- Tapping gear starts SoftAP and loads config screen with SSID, password, IP, and upload URLs
- "Apply & Exit" button stops SoftAP and returns to main hotkey view
- Inactivity timeout auto-returns from config screen to main view
- No OTA-specific UI elements remain (ota_screen, OTA button, show/hide_ota_screen)
- Display firmware compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/07-config-server-softap-http/07-02-SUMMARY.md`
</output>
