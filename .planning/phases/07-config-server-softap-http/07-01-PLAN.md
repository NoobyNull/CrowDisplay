---
phase: 07-config-server-softap-http
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - display/config_server.cpp
  - display/config_server.h
  - display/espnow_link.cpp
  - bridge/espnow_link.cpp
  - display/main.cpp
  - display/ota.cpp  # DELETED
  - display/ota.h    # DELETED
autonomous: true

must_haves:
  truths:
    - "Config server starts SoftAP on channel 1 with both config upload and OTA firmware upload endpoints on a single WebServer"
    - "ESP-NOW peers on both display and bridge explicitly use channel 1 (not auto/0)"
    - "SoftAP auto-stops after 5 minutes of inactivity (no connected clients and no HTTP requests)"
    - "Upload errors propagate correctly -- malformed JSON returns HTTP 400 with error message, not 200 success"
    - "OTA firmware upload via /update endpoint triggers ESP.restart() on success"
    - "ArduinoOTA for PlatformIO upload-port still works alongside HTTP endpoints"
    - "ESP-NOW channel is re-pinned after config_server_stop() returns to WIFI_STA mode"
  artifacts:
    - path: "display/config_server.cpp"
      provides: "Unified SoftAP manager with config upload, OTA upload, inactivity timeout, channel pinning"
      contains: "CONFIG_CHANNEL"
    - path: "display/config_server.h"
      provides: "Unified public API (start/stop/poll/active) replacing both config_server.h and ota.h"
      contains: "config_server_start"
    - path: "display/espnow_link.cpp"
      provides: "ESP-NOW init with explicit channel 1 pinning"
      contains: "esp_wifi_set_channel"
    - path: "bridge/espnow_link.cpp"
      provides: "Bridge ESP-NOW with explicit channel 1 pinning"
      contains: "esp_wifi_set_channel"
    - path: "display/main.cpp"
      provides: "Single config_server_poll() call, no ota.h include, no ota_poll()"
  key_links:
    - from: "display/config_server.cpp"
      to: "display/espnow_link.cpp"
      via: "shared WiFi channel 1 constant"
      pattern: "CONFIG_CHANNEL.*1"
    - from: "display/config_server.cpp"
      to: "display/main.cpp"
      via: "config_server_poll() called from loop()"
      pattern: "config_server_poll"
    - from: "display/espnow_link.cpp"
      to: "bridge/espnow_link.cpp"
      via: "both pin to channel 1"
      pattern: "esp_wifi_set_channel.*1"
---

<objective>
Merge OTA into config_server as a unified SoftAP manager with config upload + OTA firmware upload on a single WebServer. Add explicit WiFi channel 1 pinning on both display and bridge ESP-NOW for deterministic coexistence. Implement 5-minute inactivity timeout. Fix upload error propagation bug.

Purpose: Eliminate dual-SoftAP conflict (config_server.cpp vs ota.cpp), ensure ESP-NOW reliability during SoftAP mode, and provide the backend infrastructure for Phase 7 config mode UI.
Output: Unified config_server module, channel-pinned ESP-NOW on both devices, ota.cpp/ota.h deleted.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-config-server-softap-http/07-RESEARCH.md
@.planning/phases/05-config-data-model-sd-loading/05-01-SUMMARY.md
@.planning/phases/06-data-driven-display-ui/06-02-SUMMARY.md
@display/config_server.cpp
@display/config_server.h
@display/ota.cpp
@display/ota.h
@display/espnow_link.cpp
@bridge/espnow_link.cpp
@display/main.cpp
</context>

<tasks>

<task type="auto">
  <name>Task 1: Merge OTA into config_server with channel pinning, inactivity timeout, and error fix</name>
  <files>
    display/config_server.cpp
    display/config_server.h
    display/espnow_link.cpp
    bridge/espnow_link.cpp
  </files>
  <action>
**config_server.cpp -- Unified SoftAP Manager:**

1. Add includes: `#include <ArduinoOTA.h>`, `#include <Update.h>`, `#include <esp_wifi.h>`. Remove any reference to ota.h.

2. Add channel and timeout constants:
   ```
   #define CONFIG_CHANNEL  1
   #define INACTIVITY_TIMEOUT_MS (5 * 60 * 1000)
   ```

3. Add inactivity tracking state:
   ```
   static uint32_t last_activity_time = 0;
   ```

4. **Fix upload error propagation** (WIFI-03). Add static error state variables:
   ```
   static bool g_upload_success = false;
   static String g_upload_error = "";
   ```
   - In `handle_config_upload()` at `UPLOAD_FILE_START`: reset `g_upload_success = false; g_upload_error = "";`
   - At every early-return error point in `handle_config_upload()` (malloc fail, overflow, JSON parse error, SD write fail, rename fail, invalid config), set `g_upload_error` to a descriptive string before returning.
   - At the successful end of `UPLOAD_FILE_END` (after `request_ui_rebuild()`), set `g_upload_success = true;`
   - Rewrite `handle_config_done()` to check `g_upload_success`:
     - If true: send 200 with `{"success":true}`
     - If false: send 400 with `{"success":false,"error":"<g_upload_error>"}`

5. **Add OTA upload handlers** (moved from ota.cpp):
   ```cpp
   static void handle_ota_upload() {
       HTTPUpload &upload = web_server->upload();
       if (upload.status == UPLOAD_FILE_START) {
           Serial.printf("OTA: receiving %s\n", upload.filename.c_str());
           if (!Update.begin(UPDATE_SIZE_UNKNOWN)) {
               Update.printError(Serial);
           }
       } else if (upload.status == UPLOAD_FILE_WRITE) {
           if (Update.write(upload.buf, upload.currentSize) != upload.currentSize) {
               Update.printError(Serial);
           }
       } else if (upload.status == UPLOAD_FILE_END) {
           if (Update.end(true)) {
               Serial.printf("OTA: success, %u bytes\n", upload.totalSize);
           } else {
               Update.printError(Serial);
           }
       }
   }

   static void handle_ota_done() {
       bool ok = !Update.hasError();
       web_server->send(200, "text/html",
           ok ? "<h2>Update OK! Rebooting...</h2>"
              : "<h2>Update FAILED</h2>");
       if (ok) {
           delay(500);
           ESP.restart();
       }
   }
   ```

6. **Update the HTML landing page** to include BOTH config upload and OTA firmware upload sections. Add an OTA upload form below the config upload form:
   - Add a second `<hr>` divider
   - Add firmware upload section with file input (accept=".bin") and upload button
   - Add JavaScript `uploadFirmware()` function that POSTs to `/update` with multipart form data
   - Include PlatformIO OTA command hint: `pio run -t upload --upload-port <IP>`

7. **Update `config_server_start()`:**
   - Add channel parameter to softAP: `WiFi.softAP(CONFIG_SSID, CONFIG_PASS, CONFIG_CHANNEL)`
   - After softAP, re-pin channel: `esp_wifi_set_channel(CONFIG_CHANNEL, WIFI_SECOND_CHAN_NONE);`
   - Add ArduinoOTA setup (copied from ota.cpp):
     ```
     ArduinoOTA.setHostname("crowpanel");
     ArduinoOTA.onStart/onEnd/onProgress/onError (same as ota.cpp)
     ArduinoOTA.begin();
     ```
   - Register OTA endpoint on web_server: `web_server->on("/update", HTTP_POST, handle_ota_done, handle_ota_upload);`
   - Initialize `last_activity_time = millis();`

8. **Update `config_server_stop()`:**
   - Add `ArduinoOTA.end();` before web_server teardown
   - After `WiFi.mode(WIFI_STA)`, re-pin channel: `esp_wifi_set_channel(CONFIG_CHANNEL, WIFI_SECOND_CHAN_NONE);`

9. **Update `config_server_poll()`:**
   - Add `ArduinoOTA.handle();` call
   - Add inactivity tracking: if `WiFi.softAPgetStationNum() > 0`, reset `last_activity_time = millis();`
   - Add timeout check: if `millis() - last_activity_time > INACTIVITY_TIMEOUT_MS`, call `config_server_stop()` and log timeout message. Return a bool or set a flag so main.cpp/UI can detect the auto-stop. Add a new function `bool config_server_timed_out()` that returns true once after a timeout occurs (latching flag, cleared on read).

**config_server.h -- Updated API:**
- Remove the comment referencing "ESPAsyncWebServer from ota.cpp" (stale comment)
- Add declaration: `bool config_server_timed_out();` (returns true once after inactivity timeout)
- Keep existing: `config_server_start()`, `config_server_stop()`, `config_server_poll()`, `config_server_active()`, `config_server_set_callback()`

**display/espnow_link.cpp -- Channel pinning:**
- Add `#include <esp_wifi.h>` at top
- In `espnow_link_init()`, after `WiFi.disconnect();` and before `esp_now_init()`:
  ```
  esp_wifi_set_channel(1, WIFI_SECOND_CHAN_NONE);
  ```
- Change broadcast peer channel from `peer.channel = 0;` to `peer.channel = 1;`

**bridge/espnow_link.cpp -- Channel pinning:**
- Add `#include <esp_wifi.h>` at top
- In `espnow_link_init()`, after `WiFi.disconnect();` and before `esp_now_init()`:
  ```
  esp_wifi_set_channel(1, WIFI_SECOND_CHAN_NONE);
  ```
- In `espnow_send()`, where it creates a peer dynamically from last_sender_mac, change `peer.channel = 0;` to `peer.channel = 1;`
  </action>
  <verify>
Run `cd /data/Elcrow-Display-hotkeys && pio run -e display 2>&1 | tail -20` to verify display firmware compiles.
Run `cd /data/Elcrow-Display-hotkeys && pio run -e bridge 2>&1 | tail -20` to verify bridge firmware compiles.
Grep for `peer.channel = 0` in both espnow_link.cpp files -- should return zero matches.
Grep for `CONFIG_CHANNEL` in config_server.cpp -- should appear in softAP call, esp_wifi_set_channel calls, and #define.
Grep for `g_upload_success` in config_server.cpp -- should appear in upload handler and done handler.
  </verify>
  <done>
Both firmware targets compile cleanly. config_server.cpp contains unified SoftAP with config upload (/api/config/upload) and OTA upload (/update) endpoints, ArduinoOTA, channel pinning to channel 1, 5-minute inactivity timeout, and proper error propagation. Both display and bridge espnow_link.cpp use explicit channel 1. No references to peer.channel=0 remain.
  </done>
</task>

<task type="auto">
  <name>Task 2: Delete ota.cpp/ota.h and update main.cpp to use unified config_server</name>
  <files>
    display/ota.cpp
    display/ota.h
    display/main.cpp
  </files>
  <action>
1. **Delete `display/ota.cpp`** -- all functionality now in config_server.cpp.
2. **Delete `display/ota.h`** -- all declarations now in config_server.h.

3. **Update `display/main.cpp`:**
   - Remove `#include "ota.h"` (line 13)
   - Remove the OTA polling block (lines 88-91):
     ```
     // OTA polling (ArduinoOTA + web server)
     if (ota_active()) {
         ota_poll();
     }
     ```
   - The config_server polling block (lines 93-96) stays as-is -- it already calls `config_server_poll()` which now handles ArduinoOTA + WebServer + inactivity timeout.
   - After `config_server_poll()`, add a check for inactivity timeout auto-stop:
     ```
     // Handle config server inactivity timeout (auto-stopped)
     if (config_server_timed_out()) {
         Serial.println("Config server: timed out, returning to main view");
         // UI will handle screen transition in Plan 02
     }
     ```

4. **Verify no remaining references to ota.h or ota_* functions** in any display source file.
  </action>
  <verify>
Run `cd /data/Elcrow-Display-hotkeys && pio run -e display 2>&1 | tail -20` -- display firmware compiles with no ota.h references.
Run `cd /data/Elcrow-Display-hotkeys && pio run -e bridge 2>&1 | tail -20` -- bridge still compiles.
Verify display/ota.cpp and display/ota.h no longer exist.
Grep for `ota_start\|ota_stop\|ota_poll\|ota_active\|#include.*ota\.h` across display/ directory -- should return zero matches (except possibly ui.cpp which will be updated in Plan 02).
  </verify>
  <done>
ota.cpp and ota.h deleted. main.cpp uses only config_server module for all SoftAP/WiFi functionality. Both firmware targets compile cleanly. No dangling ota_* references in main.cpp.
  </done>
</task>

</tasks>

<verification>
1. `pio run -e display` compiles with zero errors
2. `pio run -e bridge` compiles with zero errors
3. No files named `ota.cpp` or `ota.h` exist in `display/`
4. `grep -r "peer.channel = 0" display/ bridge/` returns no matches
5. `grep "CONFIG_CHANNEL" display/config_server.cpp` shows channel pinning
6. `grep "esp_wifi_set_channel" display/espnow_link.cpp bridge/espnow_link.cpp` shows channel 1 in both
7. `grep "INACTIVITY_TIMEOUT_MS" display/config_server.cpp` shows 5-minute timeout
8. `grep "g_upload_success" display/config_server.cpp` shows error propagation fix
</verification>

<success_criteria>
- Single unified config_server module handles SoftAP lifecycle, config upload, OTA upload, ArduinoOTA, and inactivity timeout
- Both display and bridge ESP-NOW explicitly pin to WiFi channel 1
- Channel is re-pinned after config_server_stop() WiFi mode transition
- Upload errors return HTTP 400 with descriptive error JSON (not always 200)
- 5-minute inactivity timeout auto-stops SoftAP
- Both firmware targets compile cleanly
- ota.cpp and ota.h are deleted
</success_criteria>

<output>
After completion, create `.planning/phases/07-config-server-softap-http/07-01-SUMMARY.md`
</output>
