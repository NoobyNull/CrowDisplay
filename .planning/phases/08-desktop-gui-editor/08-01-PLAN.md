---
phase: 08-desktop-gui-editor
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - companion/keycode_map.py
  - companion/lvgl_symbols.py
  - companion/ui/icon_picker.py
  - companion/ui/keyboard_recorder.py
autonomous: true

must_haves:
  truths:
    - "Qt key combos translate correctly to Arduino USB HID keycodes (letters as lowercase ASCII, special keys as 0xB0+ codes)"
    - "Qt modifier flags translate correctly to device MOD_* bitmask (Ctrl=0x01, Shift=0x02, Alt=0x04, Meta/Super=0x08)"
    - "LVGL symbol names resolve to correct UTF-8 byte strings matching device firmware (e.g. HOME -> \\xEF\\x80\\x95)"
    - "Icon picker stores UTF-8 bytes for JSON serialization, not symbol name strings"
    - "Keyboard recorder captures key combos and produces correct device-format (modifiers, keycode) tuples"
  artifacts:
    - path: "companion/keycode_map.py"
      provides: "Qt-to-Arduino keycode translation table and helper functions"
      contains: "qt_key_to_arduino"
    - path: "companion/lvgl_symbols.py"
      provides: "LVGL symbol registry with name, codepoint, and UTF-8 bytes"
      contains: "SYMBOL_BY_NAME"
    - path: "companion/ui/icon_picker.py"
      provides: "Icon picker that stores/returns UTF-8 byte strings"
      contains: "icon_selected"
    - path: "companion/ui/keyboard_recorder.py"
      provides: "Keyboard shortcut recorder using correct Arduino keycodes"
      contains: "qt_key_to_arduino"
  key_links:
    - from: "companion/ui/keyboard_recorder.py"
      to: "companion/keycode_map.py"
      via: "import qt_key_to_arduino, qt_modifiers_to_device"
      pattern: "from companion.keycode_map import"
    - from: "companion/ui/icon_picker.py"
      to: "companion/lvgl_symbols.py"
      via: "import LVGL_SYMBOLS, SYMBOL_BY_UTF8"
      pattern: "from companion.lvgl_symbols import"
---

<objective>
Fix the data translation layer between Qt/Python and the device's Arduino USB HID format.

The existing editor scaffold uses wrong keycode values (ASCII instead of Arduino HID codes), stores icon names as strings instead of UTF-8 bytes, and has a broken keyboard recorder event filter. This plan creates proper mapping modules and rewrites the affected widgets.

Purpose: Without correct translation, every shortcut and icon configured in the editor would be wrong when deployed to the device.
Output: Two mapping modules (keycode_map.py, lvgl_symbols.py) and corrected icon_picker.py + keyboard_recorder.py widgets.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-desktop-gui-editor/08-RESEARCH.md
@companion/config_manager.py
@companion/ui/keyboard_recorder.py
@companion/ui/icon_picker.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create keycode and symbol mapping modules</name>
  <files>companion/keycode_map.py, companion/lvgl_symbols.py</files>
  <action>
Create `companion/keycode_map.py` with the Qt-to-Arduino keycode translation table from the research document. Must include:
- `QT_KEY_TO_ARDUINO` dict mapping Qt.Key_* constants to Arduino USB HID keycodes (0xB0 for Return, 0xDA for Up, 0xC2-0xCD for F1-F12, etc.)
- `QT_MOD_TO_DEVICE` dict mapping Qt.ControlModifier->0x01, Qt.ShiftModifier->0x02, Qt.AltModifier->0x04, Qt.MetaModifier->0x08
- `qt_key_to_arduino(qt_key: int) -> int` function: checks special key table first, then for ASCII printable chars (0x20-0x7E) converts letters to lowercase, returns the ASCII value for others
- `qt_modifiers_to_device(qt_mods) -> int` function: OR's together device modifier bits for each active Qt modifier
- `ARDUINO_KEY_NAMES` reverse lookup dict: Arduino keycode -> human-readable name string (e.g. 0xB0 -> "Return", 0xDA -> "Up")
- `arduino_keycode_to_display_name(keycode: int) -> str` function: returns human name for special keys, chr(keycode).upper() for printable ASCII

Create `companion/lvgl_symbols.py` with the full LVGL symbol registry from the research document. Must include:
- `LVGL_SYMBOLS` list of tuples: (name, unicode_codepoint, utf8_bytes) for all 58 symbols listed in the research
- `SYMBOL_BY_NAME` dict: name -> (codepoint, utf8_bytes)
- `SYMBOL_BY_UTF8` dict: utf8_bytes -> (name, codepoint)
- `symbol_name_to_utf8(name: str) -> bytes` convenience function
- `utf8_to_symbol_name(utf8: bytes) -> str` convenience function with "UNKNOWN" fallback

The UTF-8 bytes values must exactly match the device firmware's lv_symbol_def.h (e.g. HOME = b"\xEF\x80\x95"). Use the exact values from the research document Code Examples section.
  </action>
  <verify>
Run `python3 -c "from companion.keycode_map import qt_key_to_arduino, qt_modifiers_to_device, arduino_keycode_to_display_name; print('keycode_map OK')"` and `python3 -c "from companion.lvgl_symbols import LVGL_SYMBOLS, SYMBOL_BY_NAME, SYMBOL_BY_UTF8, symbol_name_to_utf8; assert symbol_name_to_utf8('HOME') == b'\\xEF\\x80\\x95'; print('lvgl_symbols OK')"` from the project root.
  </verify>
  <done>Both modules import without error. symbol_name_to_utf8("HOME") returns the correct UTF-8 bytes. qt_key_to_arduino handles both special keys and ASCII letters correctly.</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite icon picker and keyboard recorder to use correct mappings</name>
  <files>companion/ui/icon_picker.py, companion/ui/keyboard_recorder.py</files>
  <action>
**Rewrite `companion/ui/icon_picker.py`:**
- Import from `companion.lvgl_symbols` instead of hardcoded list
- Populate QComboBox items from LVGL_SYMBOLS: display text is "NAME (U+XXXX)" with Unicode preview char, itemData is the UTF-8 bytes (as a Python bytes object decoded to a string for JSON: `utf8.decode('utf-8')`)
- `set_symbol(icon_str)`: accepts either a symbol name ("HOME") or a UTF-8 string (the decoded bytes from JSON). Look up in SYMBOL_BY_UTF8 first (encode to bytes), then SYMBOL_BY_NAME. Set combo index accordingly.
- `get_symbol() -> str`: returns the UTF-8 string (decoded bytes) for JSON serialization, NOT the symbol name. This is critical -- the device JSON stores the raw UTF-8 character, not "LV_SYMBOL_HOME".
- Keep the `icon_selected` Signal(str) -- payload is the UTF-8 string.

**Rewrite `companion/ui/keyboard_recorder.py`:**
- Import `qt_key_to_arduino`, `qt_modifiers_to_device`, `arduino_keycode_to_display_name` from `companion.keycode_map`
- Replace the broken `eventFilter` approach. Instead, override `keyPressEvent(self, event)` on a custom QLineEdit subclass (or use QKeySequenceEdit as the research recommends). The simplest correct approach:
  - Use a custom QLineEdit subclass `ShortcutCapture` that overrides `keyPressEvent`.
  - In keyPressEvent: extract `event.key()` and `event.modifiers()`. Call `qt_key_to_arduino()` for the keycode. Call `qt_modifiers_to_device()` for modifiers. Filter out bare modifier keys (Shift, Ctrl, Alt, Meta alone). Update display text. Emit signal.
  - The ShortcutCapture widget shows the current shortcut as human-readable text (e.g. "Ctrl+A", "Super+1").
  - Clicking the widget puts it in focus for recording. Pressing Escape clears.
- Replace `_map_native_modifiers` and `_map_key_code` with calls to the keycode_map module functions.
- Replace `_format_shortcut` to use `arduino_keycode_to_display_name` for the key name portion.
- The `set_shortcut(modifiers, keycode)` method must use the reverse lookup to display existing config values correctly.
- Keep the same public API: `shortcut_confirmed` Signal(int, int), `current_modifiers`, `current_keycode`, `set_shortcut()`, `get_shortcut()`.
- Add a "Clear" button that resets to (0, 0).

Do NOT use QKeySequenceEdit -- the research mentions it but the custom keyPressEvent approach is simpler for this use case and avoids QKeySequenceEdit quirks with system shortcuts.
  </action>
  <verify>
Run `python3 -c "from companion.ui.icon_picker import IconPicker; from companion.ui.keyboard_recorder import KeyboardRecorder; print('widgets import OK')"` from the project root. Verify icon_picker imports from lvgl_symbols module and keyboard_recorder imports from keycode_map module by checking imports.
  </verify>
  <done>Icon picker uses UTF-8 bytes from lvgl_symbols.py (not hardcoded name strings). Keyboard recorder uses Arduino keycodes from keycode_map.py (not arbitrary ASCII). Both widgets maintain their existing signal API for integration with button_editor.py.</done>
</task>

</tasks>

<verification>
1. `python3 -c "from companion.keycode_map import qt_key_to_arduino; from companion.lvgl_symbols import LVGL_SYMBOLS"` imports cleanly
2. `python3 -c "from companion.ui.icon_picker import IconPicker; from companion.ui.keyboard_recorder import KeyboardRecorder"` imports cleanly
3. Icon picker's get_symbol() returns UTF-8 decoded string (not "LV_SYMBOL_HOME")
4. Keycode map produces 0xB0 for Qt.Key_Return, lowercase 'a' (0x61) for Qt.Key_A
</verification>

<success_criteria>
Two new mapping modules exist and are imported by the corrected widgets. The icon picker stores/returns UTF-8 byte strings matching the device JSON format. The keyboard recorder produces Arduino USB HID keycodes matching the device firmware expectations.
</success_criteria>

<output>
After completion, create `.planning/phases/08-desktop-gui-editor/08-01-SUMMARY.md`
</output>
