---
phase: 08-desktop-gui-editor
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - companion/ui/button_editor.py
  - companion/ui/editor_main.py
  - companion/config_manager.py
autonomous: true

must_haves:
  truths:
    - "User clicks a button in the grid and sees its properties in the side panel with correct color, icon, and shortcut display"
    - "User can switch between Hotkey and Media Key action types, with appropriate input controls for each"
    - "User can rename pages by double-clicking the page label or via a rename button"
    - "Grid buttons show luminance-aware text color (white on dark backgrounds, black on light)"
    - "Config JSON written by save uses UTF-8 icon strings and Arduino keycodes (not symbol names or Qt key values)"
  artifacts:
    - path: "companion/ui/button_editor.py"
      provides: "Button property editor with media key dropdown and correct format handling"
      contains: "consumer_code"
    - path: "companion/ui/editor_main.py"
      provides: "Main window with page rename, luminance-based button colors, correct icon rendering"
      contains: "rename"
    - path: "companion/config_manager.py"
      provides: "Config manager with reorder_page support"
      contains: "reorder_page"
  key_links:
    - from: "companion/ui/button_editor.py"
      to: "companion/ui/keyboard_recorder.py"
      via: "shortcut_confirmed signal -> _on_shortcut_confirmed"
      pattern: "shortcut_confirmed.connect"
    - from: "companion/ui/button_editor.py"
      to: "companion/ui/icon_picker.py"
      via: "icon_selected signal -> _on_icon_changed"
      pattern: "icon_selected.connect"
    - from: "companion/ui/editor_main.py"
      to: "companion/config_manager.py"
      via: "config operations (get/set button, add/remove/rename page)"
      pattern: "config_manager"
---

<objective>
Wire up the corrected mapping modules into the editor UI and add missing features (media key support, page rename, luminance-based text contrast).

The translation layer from Plan 01 produces correct device-format values. This plan ensures the UI reads and writes those values properly, adds media key entry via dropdown, and polishes the grid display.

Purpose: Complete the editor's functional requirements so configs produced by the editor work correctly on the device.
Output: Fully functional editor that produces valid device JSON with correct keycodes, icons, and colors.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-desktop-gui-editor/08-RESEARCH.md
@.planning/phases/08-desktop-gui-editor/08-01-SUMMARY.md
@companion/ui/button_editor.py
@companion/ui/editor_main.py
@companion/config_manager.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update button editor with media key support and correct format handling</name>
  <files>companion/ui/button_editor.py, companion/config_manager.py</files>
  <action>
**Update `companion/ui/button_editor.py`:**

1. **Media key dropdown:** Add a QComboBox `media_key_combo` populated with common USB HID consumer control codes:
   - Play/Pause = 0xCD
   - Next Track = 0xB5
   - Previous Track = 0xB6
   - Stop = 0xB7
   - Volume Up = 0xE9
   - Volume Down = 0xEA
   - Mute = 0xE2
   - Browser Home = 0x0223
   - Browser Back = 0x0224
   Display format: "Play/Pause (0xCD)" etc. Store the int code as itemData.

2. **Action type switching:** When action_type combo changes:
   - If "Hotkey" (0): show keyboard_recorder, hide media_key_combo
   - If "Media Key" (1): hide keyboard_recorder, show media_key_combo
   Use `.setVisible()` on both widgets.

3. **get_button() fix:** When action_type is MEDIA_KEY, read consumer_code from media_key_combo.currentData(), set keycode=0 and modifiers=0. When action_type is HOTKEY, set consumer_code=0 and read modifiers/keycode from keyboard_recorder.

4. **load_button() fix:** When loading a button with action_type=MEDIA_KEY, set the media_key_combo to the matching consumer_code value. Handle the case where consumer_code is not in the predefined list (add a custom "Other" entry or just select closest).

5. **Icon field:** The icon_picker now returns UTF-8 strings (from Plan 01). The get_button() method should pass this through directly as the "icon" field. When loading, icon_picker.set_symbol() already handles both formats.

**Update `companion/config_manager.py`:**

1. Add `reorder_page(self, old_index: int, new_index: int) -> bool` method that moves a page from old_index to new_index within the active profile's pages list. Use `pages.insert(new_index, pages.pop(old_index))`. Return False if either index is out of range.

2. Fix `new_config()` default icon values: change from `"LV_SYMBOL_HOME"` to the actual UTF-8 string `"\uf015"` (which is the Unicode codepoint U+F015 encoded in the JSON string for the HOME symbol). This matches what the device firmware expects.
  </action>
  <verify>
Run `python3 -c "from companion.ui.button_editor import ButtonEditor; from companion.config_manager import ConfigManager; cm = ConfigManager(); assert cm.config['profiles'][0]['pages'][0]['buttons'][0]['icon'] != 'LV_SYMBOL_HOME'; print('OK')"` from the project root.
  </verify>
  <done>Button editor supports both Hotkey and Media Key modes with appropriate input controls. Consumer code is correctly read/written. Default config icons use UTF-8 strings, not symbol name strings. ConfigManager has reorder_page method.</done>
</task>

<task type="auto">
  <name>Task 2: Update main window with page rename, grid polish, and reorder</name>
  <files>companion/ui/editor_main.py</files>
  <action>
**Update `companion/ui/editor_main.py`:**

1. **Luminance-based text color in ButtonGridWidget.refresh_grid():**
   Replace the hardcoded `color: white` in button stylesheet. Calculate luminance: `lum = 0.299 * r + 0.587 * g + 0.114 * b`. Use `color: #000` if lum > 140, else `color: #FFF`. This ensures readability on light-colored buttons.

2. **Icon display in grid buttons:** The button's icon field now contains a UTF-8 string (Unicode char like \uf015). Display this character in the button text. If the system font can't render FontAwesome codepoints (likely), fall back to showing just the label without the icon glyph, OR import SYMBOL_BY_UTF8 from lvgl_symbols and show the symbol name (e.g. "HOME") as a small text above the label. Recommended approach: try to render the UTF-8 char and if it's in the private-use Unicode range (0xF000+), show the symbol name from SYMBOL_BY_UTF8 instead.

3. **Page rename:** Add a "Rename" QPushButton to the page toolbar. When clicked, show a QInputDialog.getText() pre-filled with the current page name. On OK, call config_manager.rename_page(). Also update _update_page_display() to show the current page name.

4. **Page reorder:** Add "Move Left" and "Move Right" buttons to the page toolbar. "Move Left" calls config_manager.reorder_page(current_page, current_page - 1) then adjusts current_page. "Move Right" does the reverse. Disable when at boundaries.

5. **Selected button highlight:** Fix the current highlight approach. Instead of appending to stylesheet (which doesn't work with overrides), use a dedicated border style. When a button is selected, set `border: 3px solid #FFD700` (gold). Unselected buttons get `border: 2px solid #555`.

6. **Keyboard shortcuts for file operations:** Add QShortcut or QAction keyboard shortcuts:
   - Ctrl+N for New
   - Ctrl+O for Open
   - Ctrl+S for Save
  </action>
  <verify>
Run `python3 -c "from companion.ui.editor_main import EditorMainWindow, ButtonGridWidget; print('editor_main imports OK')"` from the project root.
  </verify>
  <done>Grid buttons display with correct contrast text colors. Page rename works via button and dialog. Page reorder moves pages left/right. Selected button has a visible highlight. File operations have keyboard shortcuts.</done>
</task>

</tasks>

<verification>
1. All companion/ui/*.py files import without error
2. `python3 companion/crowpanel_editor.py --help` prints usage without crashing
3. ConfigManager.new_config() produces icons as UTF-8 strings, not "LV_SYMBOL_*" names
4. Button editor shows/hides shortcut recorder vs media key dropdown based on action type
5. Grid buttons have readable text on both light and dark backgrounds
</verification>

<success_criteria>
The editor app launches, displays a button grid with readable text, allows editing button properties including media keys, supports page rename and reorder, and produces JSON configs that match the device's expected format (UTF-8 icon strings, Arduino keycodes, correct modifier bitmasks, consumer control codes).
</success_criteria>

<output>
After completion, create `.planning/phases/08-desktop-gui-editor/08-02-SUMMARY.md`
</output>
