---
phase: 04-battery-management-power-states
plan: 04
type: execute
wave: 3
depends_on: ["04-02", "04-03"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Display runs on battery (if connected) with battery percentage in stats header"
    - "Stats header shows device status: battery, ESP-NOW link, brightness control"
    - "Display dims after idle timeout then enters clock mode on shutdown signal"
    - "Display wakes from clock mode when bridge comes online"
    - "Brightness cycles through presets when tapping header icon"
    - "Companion sends shutdown signal before PC powers off"
  artifacts: []
  key_links: []
---

<objective>
End-to-end verification of Phase 4: battery monitoring, power state machine, clock mode, brightness control, shutdown/wake signaling, and device status indicators.

Purpose: Confirm all Phase 4 success criteria are met on real hardware before marking the phase complete.
Output: Verified Phase 4 functionality or identified gaps for closure.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-battery-management-power-states/04-01-SUMMARY.md
@.planning/phases/04-battery-management-power-states/04-02-SUMMARY.md
@.planning/phases/04-battery-management-power-states/04-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build verification</name>
  <files></files>
  <action>
1. Run `pio run -e display` and verify clean compilation (zero errors).
2. Run `pio run -e bridge` and verify clean compilation (zero errors).
3. Run `python3 -m py_compile companion/hotkey_companion.py` and verify no syntax errors.
4. Verify companion has `dbus-next` available: `python3 -c "import dbus_next; print('OK')"` -- if not installed, note as expected (graceful degradation).
5. Verify key integration points exist:
   - `grep -q "MSG_POWER_STATE" shared/protocol.h` (protocol extended)
   - `grep -q "power_update" display/main.cpp` (power state machine in loop)
   - `grep -q "show_clock_mode" display/main.cpp` (clock mode transition)
   - `grep -q "MSG_POWER_STATE" bridge/main.cpp` (bridge relay)
   - `grep -q "PrepareForShutdown\|shutdown_event" companion/hotkey_companion.py` (D-Bus listener)
   - `grep -q "MSG_TIME_SYNC\|0x06" companion/hotkey_companion.py` (time sync)
  </action>
  <verify>All three targets compile/parse cleanly. All grep checks pass.</verify>
  <done>Build verification confirms all code compiles and key integration points are wired correctly.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Hardware verification</name>
  <files></files>
  <action>Human verification checkpoint -- see what-built and how-to-verify below.</action>
  <verify>User confirms all tests pass.</verify>
  <done>All Phase 4 success criteria verified on real hardware.</done>
  <what-built>
Phase 4 battery management and power state system:
- Battery monitoring via MAX17048 I2C fuel gauge (graceful degradation if not connected)
- Power state machine: ACTIVE -> DIMMED (60s idle) -> CLOCK_MODE (on shutdown signal)
- Device status in header: battery %, ESP-NOW link indicator, brightness control
- Clock mode screen: large time + battery percentage
- D-Bus shutdown signaling from companion through bridge to display
- Wake detection: display returns to ACTIVE when bridge messages resume
- Time sync: companion sends epoch time with each stats update
  </what-built>
  <how-to-verify>
**Flash both firmware targets:**
1. `pio run -e display -t upload` (flash display)
2. `pio run -e bridge -t upload` (flash bridge)

**Test 1: Stats header device status (DISP-08)**
3. Start companion: `python3 companion/hotkey_companion.py`
4. Verify stats header appears with system metrics (existing functionality)
5. Verify device status indicators are visible in the title bar:
   - Battery: Shows "BAT N/A" if no MAX17048 connected, or "BAT XX%" if fuel gauge present
   - ESP-NOW link: Green icon when companion is streaming, grey after 10s of no messages
   - Brightness: Tappable icon visible in header

**Test 2: Brightness control (DISP-11)**
6. Tap the brightness icon in the header
7. Verify display brightness changes visibly (cycles through HIGH/MED/LOW presets)
8. Tap again to cycle to next level
9. Verify brightness returns to HIGH after cycling through all three

**Test 3: Idle dimming (PWR-03)**
10. Stop touching the display for 60+ seconds
11. Verify display dims (backlight reduces noticeably)
12. Touch the display
13. Verify display returns to full brightness

**Test 4: Clock mode (DISP-09, PWR-04) -- if dbus-next installed**
14. Install dbus-next if not present: `pip install dbus-next`
15. Restart companion: `python3 companion/hotkey_companion.py`
16. Verify time display on clock mode by simulating: Send a mock shutdown signal OR use `systemctl suspend` (which triggers PrepareForShutdown) and cancel immediately, or test by stopping the companion and checking if the display enters clock mode after stats timeout (note: this is different from shutdown-triggered clock mode)
17. Alternative manual test: Add a temporary keyboard shortcut in companion to send MSG_POWER_STATE shutdown for testing

**Test 5: Wake from clock mode (DISP-10)**
18. While in clock mode, restart the companion (simulating PC boot)
19. Verify display transitions back to the hotkey view with full brightness

**Test 6: Hotkey functionality preserved**
20. After wake, tap hotkey buttons on each page
21. Verify keystrokes still fire correctly on the PC
22. Verify media keys still work
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe which tests failed and what was observed.</resume-signal>
</task>

</tasks>

<verification>
Phase 4 success criteria from ROADMAP.md:
1. Display runs on LiPo battery with battery percentage shown in the stats header bar
2. Stats header shows device status indicators: battery level, ESP-NOW link state, and brightness control
3. Display dims after idle timeout, then enters clock mode when companion app sends shutdown signal
4. Display wakes from clock mode automatically when the bridge comes back online
5. User can adjust display brightness from the stats header without leaving the hotkey view
</verification>

<success_criteria>
All 5 Phase 4 success criteria verified on real hardware. No regressions in hotkey or media key functionality from Phase 3.
</success_criteria>

<output>
After completion, create `.planning/phases/04-battery-management-power-states/04-04-SUMMARY.md`
</output>
