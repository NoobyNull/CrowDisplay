---
phase: 03-stats-display-companion-app
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - display/stats_header.h
  - display/stats_header.cpp
  - display/ui.h
  - display/ui.cpp
  - display/espnow_link.h
  - display/espnow_link.cpp
  - display/main.cpp
autonomous: true

must_haves:
  truths:
    - "Display shows a persistent stats header bar with CPU, RAM, GPU, network, and disk usage"
    - "Stats header updates at 1-2 Hz when bridge sends MSG_STATS"
    - "Stats header remains visible while user navigates between hotkey pages"
    - "Display has media key buttons (play/pause, volume, next/prev, mute) that send MSG_MEDIA_KEY to bridge"
    - "GPU shows N/A when sentinel value 0xFF received"
  artifacts:
    - path: "display/stats_header.h"
      provides: "Stats header bar creation and update interface"
      exports: ["create_stats_header", "update_stats_header"]
    - path: "display/stats_header.cpp"
      provides: "LVGL stats header with 6 stat labels in flex row"
      contains: "lv_label_set_text_fmt"
    - path: "display/ui.cpp"
      provides: "Updated UI with stats header replacing title + media key page"
      contains: "MEDIA_PLAY_PAUSE"
    - path: "display/espnow_link.cpp"
      provides: "MSG_STATS reception and media key sending"
      contains: "MSG_STATS"
  key_links:
    - from: "display/main.cpp"
      to: "display/stats_header.cpp"
      via: "update_stats_header() called when MSG_STATS received"
      pattern: "update_stats_header"
    - from: "display/espnow_link.cpp"
      to: "shared/protocol.h"
      via: "StatsMsg parsing from ESP-NOW payload"
      pattern: "StatsMsg"
    - from: "display/ui.cpp"
      to: "display/espnow_link.cpp"
      via: "send_media_key_to_bridge() from button callback"
      pattern: "send_media_key"
---

<objective>
Replace the display's header bar with a live stats header showing CPU, RAM, GPU, network, and disk usage, and add media key buttons to the hotkey UI. The stats header persists across tab navigation and updates when MSG_STATS messages arrive from the bridge.

Purpose: The display becomes a live system monitor + media controller alongside its existing hotkey function.

Output: Display firmware with persistent stats header bar and media key page.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-stats-display-companion-app/03-RESEARCH.md
@.planning/phases/03-stats-display-companion-app/03-01-SUMMARY.md
@shared/protocol.h
@display/ui.h
@display/ui.cpp
@display/main.cpp
@display/espnow_link.h
@display/espnow_link.cpp
@display/display_hw.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create stats header module and update ESP-NOW to handle MSG_STATS</name>
  <files>display/stats_header.h, display/stats_header.cpp, display/espnow_link.h, display/espnow_link.cpp</files>
  <action>
1. Create `display/stats_header.h`:
   ```cpp
   #pragma once
   #include <lvgl.h>
   #include "protocol.h"

   // Create the stats header bar inside the given parent (45px tall, full width).
   // Replaces any existing children of parent.
   void create_stats_header(lv_obj_t *header);

   // Update stats labels with new data from bridge.
   // Safe to call at any frequency -- only redraws if values changed.
   void update_stats_header(const StatsMsg &stats);
   ```

2. Create `display/stats_header.cpp`:
   - Store static pointers to 6 lv_label_t objects: cpu_label, ram_label, gpu_label, net_up_label, net_down_label, disk_label.
   - `create_stats_header(lv_obj_t *header)`:
     - Call `lv_obj_clean(header)` to remove existing title/status children.
     - Set flex flow: `lv_obj_set_flex_flow(header, LV_FLEX_FLOW_ROW)`.
     - Set flex align: `LV_FLEX_ALIGN_SPACE_EVENLY, LV_FLEX_ALIGN_CENTER, LV_FLEX_ALIGN_CENTER`.
     - Disable scrolling: `lv_obj_clear_flag(header, LV_OBJ_FLAG_SCROLLABLE)`.
     - For each of the 6 stats, create a label with initial placeholder text:
       - CPU: `"CPU --%"` with color 0x3498DB (blue)
       - RAM: `"RAM --%"` with color 0x2ECC71 (green)
       - GPU: `"GPU --%"` with color 0x9B59B6 (purple)
       - UP: `"^ -- K"` with color 0xE67E22 (orange)
       - DN: `"v -- K"` with color 0x1ABC9C (teal)
       - DSK: `"DSK --%"` with color 0xE74C3C (red)
     - Use `lv_font_montserrat_14` for all labels. Text color per-label as above.
   - `update_stats_header(const StatsMsg &stats)`:
     - Update each label using `lv_label_set_text_fmt()`:
       - CPU: `"CPU %d%%"` with stats.cpu_percent
       - RAM: `"RAM %d%%"` with stats.ram_percent
       - GPU: If stats.gpu_percent == 0xFF, show `"GPU N/A"`, else `"GPU %d%%"`
       - Network up: Format as KB/s or MB/s. If net_up_kbps >= 1024, show `"^ %.1fM"` (value/1024.0f), else `"^ %dK"`.
       - Network down: Same formatting as up with `"v"` prefix.
       - DSK: `"DSK %d%%"` with stats.disk_percent

3. Update `display/espnow_link.h`:
   - Add: `void send_media_key_to_bridge(uint16_t consumer_key);`
   - Add: `bool espnow_poll_stats(StatsMsg &stats);` (poll for incoming MSG_STATS)

4. Update `display/espnow_link.cpp`:
   - The existing `on_recv` callback and ring buffer currently handle only MSG_HOTKEY_ACK in `espnow_poll_ack()`. Extend to also queue MSG_STATS messages.
   - Add a second ring buffer (or extend the existing one) for stats messages. Simplest approach: use the existing generic ring buffer but add a second poll function that filters by type.
   - Actually, looking at the code: the existing `on_recv` already queues ALL incoming message types generically (type + payload). But `espnow_poll_ack()` only dequeues. Refactor:
     - Rename internal approach: keep the generic ring buffer as-is.
     - Add `espnow_poll_stats(StatsMsg &stats)` that dequeues MSG_STATS messages.
     - Keep `espnow_poll_ack()` that dequeues MSG_HOTKEY_ACK messages.
     - Both functions scan the ring buffer for their respective type. Use a simple approach: add a second small ring buffer specifically for stats (since stats arrive at 2 Hz and we only need the latest value, a single-slot buffer with atomic flag works fine).
   - Better approach for simplicity: split into two ring buffers in `on_recv`:
     - If type == MSG_HOTKEY_ACK, queue to ack_queue (existing behavior)
     - If type == MSG_STATS, store in a single `StatsMsg latest_stats` with a `volatile bool stats_ready` flag (we only ever need the latest stats, not a queue)
     - `espnow_poll_stats()`: if stats_ready, copy latest_stats to output, clear flag, return true
   - Add `send_media_key_to_bridge(uint16_t consumer_key)`:
     - Create a MediaKeyMsg, pack the consumer_key.
     - Call `espnow_send(MSG_MEDIA_KEY, (uint8_t *)&msg, sizeof(msg))`.
  </action>
  <verify>
Run `cd /data/Elcrow-Display-hotkeys && pio run -e display`. Must compile with no errors. Verify stats_header.cpp and updated espnow_link.cpp are linked.
  </verify>
  <done>Stats header module exists with create/update functions. ESP-NOW link on display side can receive MSG_STATS and send MSG_MEDIA_KEY. Display firmware compiles.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate stats header into UI and add media key page</name>
  <files>display/ui.h, display/ui.cpp, display/main.cpp</files>
  <action>
1. Update `display/ui.h`:
   - Add: `lv_obj_t* get_header();` (returns the header object for stats_header to populate)
   - Keep existing `create_ui()`.

2. Update `display/ui.cpp`:
   - Add `#include "stats_header.h"` and `#include "protocol.h"` (for media key constants).
   - Store the header pointer as a file-static variable (it already is created locally in create_ui, just promote to static).
   - In `create_ui()`, AFTER creating the header object (lines 217-236 current), call `create_stats_header(header)` instead of creating the title and status_label manually. Remove the title label and status_label creation code. Remove the `status_label` static variable (no longer needed -- stats header replaces it).
   - In `btn_event_cb()`, remove the `status_label` update (lines 131-133). The status feedback is no longer shown in the header (it is now a stats display). Optionally log to Serial only.
   - Add `get_header()` that returns the static header pointer.
   - Replace Page 3 ("Dev Tools") content with media keys. Create a new `page3_media` array:
     ```cpp
     // Page 3 uses MediaKeyMsg instead of HotkeyMsg, so buttons need a different callback
     ```
     Actually, media keys use a DIFFERENT protocol message (MSG_MEDIA_KEY with consumer_key, not MSG_HOTKEY with modifier+keycode). So media key buttons need a different event callback:
   - Add a `media_btn_event_cb` that calls `send_media_key_to_bridge(consumer_key)` instead of `send_hotkey_to_bridge()`.
   - Define media key button data. Use a simple struct:
     ```cpp
     struct MediaKey {
         const char *label;
         const char *icon;
         uint16_t consumer_key;
         uint32_t color;
     };
     ```
   - Define 7 media keys (fits nicely in the grid):
     - Play/Pause (MEDIA_PLAY_PAUSE, 0xCD) - green, LV_SYMBOL_PLAY
     - Stop (MEDIA_STOP, 0xB7) - red, LV_SYMBOL_STOP
     - Previous (MEDIA_PREV, 0xB6) - blue, LV_SYMBOL_PREV
     - Next (MEDIA_NEXT, 0xB5) - blue, LV_SYMBOL_NEXT
     - Vol Up (MEDIA_VOL_UP, 0xE9) - orange, LV_SYMBOL_VOLUME_MAX
     - Vol Down (MEDIA_VOL_DOWN, 0xEA) - orange, LV_SYMBOL_VOLUME_MID
     - Mute (MEDIA_MUTE, 0xE2) - grey, LV_SYMBOL_MUTE
   - Create a `create_media_page()` function similar to `create_hotkey_page()` but using the media key struct and media callback. Reuse the same button styling (same size 170x90, same color/icon/label pattern). Buttons should show icon + label (no "description" line needed since there is no shortcut combo to display).
   - Update the `pages[]` array: keep Page 1 (General) and Page 2 (Windows), replace Page 3 with a special case. In `create_ui()`, when creating tabs, handle page 3 differently: call `create_media_page(tab)` instead of `create_hotkey_page()`.
   - Keep the existing Dev Tools hotkeys available -- move them to a Page 4 or keep page 3 as dev tools and add media as page 4. Actually, the research says "Page 3 media keys replaced with keyboard-only dev shortcuts (consumer control deferred to Phase 3)". This means the original plan was for Page 3 to BE media keys, but they were temporarily replaced with dev shortcuts. So now: restore Page 3 as Media, and if 4 pages is fine, keep Dev Tools as Page 4. 4 tabs fit well in 800px (200px each). Do this: pages = General, Windows, Media, Dev Tools.

3. Update `display/main.cpp`:
   - Add `#include "stats_header.h"` and `#include "protocol.h"`.
   - In `loop()`, poll for incoming stats and update the header:
     ```cpp
     StatsMsg stats;
     if (espnow_poll_stats(stats)) {
         update_stats_header(stats);
     }
     ```
   - Keep existing ACK polling.
  </action>
  <verify>
Run `cd /data/Elcrow-Display-hotkeys && pio run -e display`. Must compile with no errors. Verify ui.cpp references media key constants from protocol.h and stats_header functions.
  </verify>
  <done>Display UI has: (1) persistent stats header bar at top showing CPU/RAM/GPU/NET/DSK with placeholder values, (2) four tabview pages -- General, Windows, Media, Dev Tools, (3) media key buttons that send MSG_MEDIA_KEY via ESP-NOW, (4) main loop polls for MSG_STATS and updates header labels in real time.</done>
</task>

</tasks>

<verification>
- `pio run -e display` compiles the display firmware with zero errors
- Stats header is created inside the existing 45px header bar (no layout change to tabview)
- Media key buttons use send_media_key_to_bridge() with correct consumer control codes
- Stats header update function handles GPU sentinel (0xFF -> "N/A")
- Network speeds formatted as KB/s or MB/s
- 4 tab pages visible: General, Windows, Media, Dev Tools
</verification>

<success_criteria>
Display firmware compiles and contains: persistent stats header bar with 6 stat labels (CPU, RAM, GPU, NET up, NET down, DSK), media key page with 7 buttons (play/pause, stop, prev, next, vol up, vol down, mute), and main loop integration that updates stats header when MSG_STATS arrives from bridge.
</success_criteria>

<output>
After completion, create `.planning/phases/03-stats-display-companion-app/03-02-SUMMARY.md`
</output>
