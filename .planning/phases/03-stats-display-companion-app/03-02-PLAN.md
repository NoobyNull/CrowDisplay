---
phase: 03-stats-display-companion-app
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - display/ui.h
  - display/ui.cpp
  - display/main.cpp
  - display/espnow_link.h
  - display/espnow_link.cpp
autonomous: true

must_haves:
  truths:
    - "Display shows persistent two-row stats header (90px) with CPU%, RAM%, GPU%, CPU temp, GPU temp, Net up, Net down, Disk%"
    - "Stats header hides when no stats received and appears automatically on first MSG_STATS"
    - "Stats header remains visible while navigating between hotkey pages"
    - "Page 1 shows Hyprland window management hotkeys (workspaces, focus, kill, fullscreen, float)"
    - "Page 2 shows Hyprland system actions (terminal, file manager, launcher, browser, screenshots)"
    - "Page 3 shows media keys (play/pause, volume, next/prev, mute) plus extra workspace/window shortcuts"
    - "Media key buttons send MSG_MEDIA_KEY over ESP-NOW instead of MSG_HOTKEY"
  artifacts:
    - path: "display/ui.cpp"
      provides: "Stats header, Hyprland hotkey pages, media key support"
      contains: "StatsPayload"
    - path: "display/ui.h"
      provides: "create_ui, update_stats declarations"
      exports: ["create_ui", "update_stats"]
    - path: "display/main.cpp"
      provides: "MSG_STATS polling and dispatch to UI"
      contains: "MSG_STATS"
    - path: "display/espnow_link.h"
      provides: "espnow_poll for MSG_STATS"
  key_links:
    - from: "display/main.cpp"
      to: "display/ui.cpp"
      via: "update_stats() called when MSG_STATS received"
      pattern: "update_stats"
    - from: "display/ui.cpp"
      to: "display/espnow_link.h"
      via: "send_media_key_to_bridge() for media buttons"
      pattern: "send_media_key"
    - from: "display/main.cpp"
      to: "display/espnow_link.h"
      via: "espnow_poll() now returns MSG_STATS messages"
      pattern: "MSG_STATS"
---

<objective>
Rework the display firmware: replace all three hotkey pages with Hyprland Linux shortcuts, add the persistent two-row stats header bar, and add MSG_STATS reception + MSG_MEDIA_KEY sending.

Purpose: Transform the display from a generic Windows shortcut panel into a Hyprland-specific command center with live system stats. The stats header shows PC metrics when the companion is running and hides cleanly when it is not.

Output: Complete display UI rework with Hyprland pages (window mgmt, system actions, media+extras), stats header bar, and ESP-NOW handling for stats/media messages.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-stats-display-companion-app/03-RESEARCH.md
@.planning/phases/03-stats-display-companion-app/03-CONTEXT.md
@.planning/phases/03-stats-display-companion-app/03-01-SUMMARY.md
@shared/protocol.h
@display/ui.h
@display/ui.cpp
@display/main.cpp
@display/display_hw.h
@display/espnow_link.h
@display/espnow_link.cpp
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rework hotkey pages for Hyprland and add media key support</name>
  <files>display/ui.h, display/ui.cpp, display/espnow_link.h, display/espnow_link.cpp</files>
  <action>
**display/espnow_link.h:** Add new declarations:
- `void send_media_key_to_bridge(uint16_t consumer_code);` -- sends MSG_MEDIA_KEY
- `bool espnow_poll_msg(uint8_t &type, uint8_t *payload, uint8_t &payload_len);` -- generic poll that returns any message type (not just ACK). If this function already exists as `espnow_poll` with type out-param on the bridge side, add it to display side too. The display needs to receive MSG_STATS messages from the bridge.

**display/espnow_link.cpp:** Implement:
- `send_media_key_to_bridge()`: Pack MediaKeyMsg, call `espnow_send(MSG_MEDIA_KEY, ...)`.
- `espnow_poll_msg()`: Similar to existing espnow_poll_ack but returns full message type + payload instead of just ACK status. Must handle MSG_STATS in the receive callback queue.

**display/ui.h:** Add declaration:
- `void update_stats(const StatsPayload *stats);` -- called from main.cpp when MSG_STATS arrives

**display/ui.cpp:** Complete rework:

1. **Extend the Hotkey struct** to support media keys. Add a `bool is_media` field and a `uint16_t consumer_code` field. When is_media is true, the button event handler calls `send_media_key_to_bridge(hk->consumer_code)` instead of `send_hotkey_to_bridge(hk->modifiers, hk->keycode)`.

2. **Replace page1_hotkeys with Hyprland Window Management (12 keys):**
   - Workspace 1: Super+1 (MOD_GUI, '1')
   - Workspace 2: Super+2 (MOD_GUI, '2')
   - Workspace 3: Super+3 (MOD_GUI, '3')
   - Workspace 4: Super+4 (MOD_GUI, '4')
   - Focus Left: Super+Left (MOD_GUI, KEY_LEFT_ARROW)
   - Focus Right: Super+Right (MOD_GUI, KEY_RIGHT_ARROW)
   - Focus Up: Super+Up (MOD_GUI, KEY_UP_ARROW)
   - Focus Down: Super+Down (MOD_GUI, KEY_DOWN_ARROW)
   - Kill Window: Super+Q (MOD_GUI, 'q')
   - Fullscreen: Super+F (MOD_GUI, 'f')
   - Float Toggle: Super+Shift+Space (MOD_GUI|MOD_SHIFT, ' ')
   - Workspace 5: Super+5 (MOD_GUI, '5')
   Page name: "Windows"

3. **Replace page2_hotkeys with Hyprland System Actions (12 keys):**
   - Terminal: Super+Return (MOD_GUI, KEY_RETURN/0xB0)
   - File Manager: Super+T (MOD_GUI, 't')
   - App Launcher: Super+D (MOD_GUI, 'd')
   - Browser: Super+B (MOD_GUI, 'b')
   - Screenshot: Super+Shift+S (MOD_GUI|MOD_SHIFT, 's')
   - Full Screenshot: Print (MOD_NONE, KEY_PRINT_SCREEN/0xCE)
   - Color Picker: Super+Shift+C (MOD_GUI|MOD_SHIFT, 'c')
   - Lock Screen: Super+L (MOD_GUI, 'l')
   - Logout: Super+Shift+Q (MOD_GUI|MOD_SHIFT, 'q')
   - Notifications: Super+N (MOD_GUI, 'n')
   - Clipboard: Super+V (MOD_GUI, 'v')
   - Settings: Super+I (MOD_GUI, 'i')
   Page name: "System"

4. **Replace page3_hotkeys with Media + Extras (12 keys):**
   First 6 are media keys (is_media=true):
   - Play/Pause: consumer_code=0x00CD
   - Next Track: consumer_code=0x00B5
   - Prev Track: consumer_code=0x00B4
   - Volume Up: consumer_code=0x00E9
   - Volume Down: consumer_code=0x00EA
   - Mute: consumer_code=0x00E2
   Last 6 are keyboard shortcuts:
   - Workspace 6: Super+6 (MOD_GUI, '6')
   - Workspace 7: Super+7 (MOD_GUI, '7')
   - Workspace 8: Super+8 (MOD_GUI, '8')
   - Move Win Left: Super+Ctrl+H (MOD_GUI|MOD_CTRL, 'h')
   - Move Win Right: Super+Ctrl+L (MOD_GUI|MOD_CTRL, 'l')
   - Resize Mode: Super+R (MOD_GUI, 'r')
   Page name: "Media"

5. **Update btn_event_cb:** Check `hk->is_media`. If true, call `send_media_key_to_bridge(hk->consumer_code)`. If false, call existing `send_hotkey_to_bridge(hk->modifiers, hk->keycode)`.

6. **Update key code defines:** Add KEY_RETURN (0xB0), KEY_PRINT_SCREEN (0xCE) if not already defined. Remove any key codes no longer used.

7. **Update color assignments:** Use distinct colors per category. Window mgmt keys in blue/teal tones, system actions in green/orange tones, media keys in purple/pink tones, workspace keys keep blue.

8. **Keep the page name array and pages[] structure.** Update page names to "Windows", "System", "Media".

9. **Stats header creation** (in create_ui):
   - Create a container `stats_header` at LV_ALIGN_TOP_MID, y=45 (below existing title header), size 800x90
   - Background: dark (0x0d1b2a), no border, no radius, no scroll
   - Start HIDDEN (LV_OBJ_FLAG_HIDDEN)
   - Row 1 (top 45px of the 90px container): 5 labels evenly spaced: "CPU --%", "RAM --%", "GPU --%", "CPU --C", "GPU --C"
   - Row 2 (bottom 45px): 3 labels: "Up -- KB/s", "Down -- KB/s", "Disk --%"
   - Font: lv_font_montserrat_14 for labels, lv_font_montserrat_16 for values
   - Colors: white text, with colored value accents (CPU blue, RAM green, GPU orange, temps red/yellow, network teal, disk grey)
   - Store label pointers in a static array for update_stats() to modify

10. **Implement update_stats(const StatsPayload *stats):**
    - Show stats_header if hidden (clear LV_OBJ_FLAG_HIDDEN)
    - When showing for first time, resize tabview: set height to SCREEN_HEIGHT - 45 - 90 = 345, align to bottom
    - Update each label with formatted values from StatsPayload
    - For 0xFF values (unavailable), show "N/A" instead of number
    - For network: if net_up_kbps >= 1024, show as "X.X MB/s", else "X KB/s"
    - Track last update timestamp. If called from main loop and no update for >5 seconds, hide header and restore tabview size. (Optional: implement timeout in main.cpp loop instead.)

11. **Tabview sizing:** Initially set tabview to SCREEN_HEIGHT - 45 (no stats header). When stats appear, resize to SCREEN_HEIGHT - 45 - 90. When stats timeout, restore.
  </action>
  <verify>`cd /data/Elcrow-Display-hotkeys && pio run -e display` compiles without errors.</verify>
  <done>All three hotkey pages contain Hyprland shortcuts. Page 3 media buttons send MSG_MEDIA_KEY. Stats header container exists (hidden by default) with 8 labels for metrics. update_stats() updates labels and shows header.</done>
</task>

<task type="auto">
  <name>Task 2: Wire MSG_STATS reception into display main loop</name>
  <files>display/main.cpp</files>
  <action>
In display/main.cpp:

1. Add `#include "protocol.h"` if not already present (for StatsPayload).
2. In loop(), add polling for MSG_STATS messages from bridge using the new espnow_poll_msg() function. Check for incoming messages every loop iteration (it is non-blocking). When msg_type == MSG_STATS and payload_len >= sizeof(StatsPayload), call `update_stats((const StatsPayload *)payload)`.
3. Optionally: Add a stats timeout check. If millis() since last update_stats() call exceeds 5000ms, call a `hide_stats_header()` function (or handle inside update_stats with a "timeout" mode). This ensures the header hides when the companion stops.
4. Keep all existing code (touch_poll, lvgl_tick, espnow_poll_ack) unchanged.

Note: The display now needs both espnow_poll_ack() (for hotkey ACKs) AND espnow_poll_msg() (for stats). Make sure both are called. The underlying receive callback should queue all message types; poll functions filter by type.
  </action>
  <verify>`cd /data/Elcrow-Display-hotkeys && pio run -e display` compiles without errors.</verify>
  <done>Display main loop polls for MSG_STATS, dispatches to update_stats(), and handles stats timeout (header hides after 5s of no data).</done>
</task>

</tasks>

<verification>
- `pio run -e display` compiles cleanly
- ui.cpp contains Hyprland shortcuts for all 3 pages (grep for "Super+" or MOD_GUI in hotkey definitions)
- ui.cpp contains stats_header creation with 8 labels
- ui.cpp contains update_stats() function
- main.cpp polls for MSG_STATS and calls update_stats()
- Media key buttons use send_media_key_to_bridge() not send_hotkey_to_bridge()
</verification>

<success_criteria>
Display firmware compiles with reworked Hyprland hotkey pages, stats header UI, and MSG_STATS/MSG_MEDIA_KEY integration. Stats header is hidden by default and shows when stats arrive. Media keys on Page 3 send consumer control codes via MSG_MEDIA_KEY.
</success_criteria>

<output>
After completion, create `.planning/phases/03-stats-display-companion-app/03-02-SUMMARY.md`
</output>
