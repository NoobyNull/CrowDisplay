---
phase: 03-stats-display-companion-app
plan: 04
type: execute
wave: 3
depends_on: ["03-02", "03-03"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Both firmware targets compile cleanly"
    - "Companion app runs without syntax errors"
    - "User verifies stats header appears on display when companion streams data"
    - "User verifies media keys fire on PC"
    - "User verifies Hyprland hotkeys work from display"
  artifacts: []
  key_links: []
---

<objective>
End-to-end verification of the complete Phase 3 pipeline: companion streams stats through bridge to display header, media keys work, and Hyprland hotkeys fire correctly.

Purpose: Confirm all three components (companion, bridge, display) work together as an integrated system before marking Phase 3 complete.

Output: Verified working system or list of issues to fix.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-stats-display-companion-app/03-01-SUMMARY.md
@.planning/phases/03-stats-display-companion-app/03-02-SUMMARY.md
@.planning/phases/03-stats-display-companion-app/03-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build verification -- compile both firmware targets</name>
  <files></files>
  <action>
Run both firmware builds:
- `cd /data/Elcrow-Display-hotkeys && pio run -e bridge` -- must compile cleanly
- `cd /data/Elcrow-Display-hotkeys && pio run -e display` -- must compile cleanly

Check companion syntax:
- `python3 -c "import ast; ast.parse(open('companion/hotkey_companion.py').read())"` -- must pass

If any fail, diagnose and fix the issues before proceeding to checkpoint.
  </action>
  <verify>Both `pio run -e bridge` and `pio run -e display` exit 0. Python syntax check passes.</verify>
  <done>All three components (bridge firmware, display firmware, companion app) build/parse without errors.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: End-to-end functional verification</name>
  <files></files>
  <action>
Flash both firmware targets to hardware and run the companion app. Present the verification checklist to the user for hands-on testing.

Setup steps to execute before presenting checklist:
1. Flash bridge: `cd /data/Elcrow-Display-hotkeys && pio run -e bridge -t upload`
2. Flash display: `pio run -e display -t upload`
3. Instruct user to unplug and replug bridge USB cable for re-enumeration.
  </action>
  <verify>
User confirms all checklist items pass:

**Setup:**
1. Install udev rule: `sudo cp companion/99-hotkey-bridge.rules /etc/udev/rules.d/ && sudo udevadm control --reload-rules && sudo udevadm trigger`
2. Unplug and replug bridge USB cable (for new composite descriptor + udev rule)
3. Verify composite HID: `lsusb -d 303a:0002 -v 2>/dev/null | head -50` (should show multiple HID interfaces)
4. Install companion deps: `pip install -r companion/requirements.txt`
5. Run companion: `python3 companion/hotkey_companion.py`

**Stats header verification:**
- [ ] Companion connects and logs "Connected to HotkeyBridge"
- [ ] Display shows stats header bar within 2 seconds
- [ ] Row 1 shows CPU%, RAM%, GPU% (or N/A), CPU temp, GPU temp
- [ ] Row 2 shows Net up, Net down, Disk%
- [ ] Stats update every ~1 second
- [ ] Stop companion (Ctrl+C) -- header should hide after ~5 seconds

**Hotkey verification (Hyprland must be running):**
- [ ] Page 1 "Windows": Tap "Workspace 1" -- switches to workspace 1
- [ ] Page 1: Tap "Kill Window" -- kills focused window (open a test window first)
- [ ] Page 2 "System": Tap "Terminal" -- opens terminal
- [ ] Page 2: Tap "Screenshot" -- activates area selection (grim+slurp)

**Media key verification:**
- [ ] Page 3 "Media": Tap "Play/Pause" -- toggles media playback (have a media player open)
- [ ] Page 3: Tap "Volume Up" -- system volume increases
- [ ] Page 3: Tap "Mute" -- system mutes

**Navigation verification:**
- [ ] Stats header stays visible when swiping between pages
- [ ] Hotkey buttons do not overlap with stats header
  </verify>
  <done>User confirms stats pipeline, Hyprland hotkeys, and media keys all work end-to-end. Stats header shows/hides correctly.</done>
</task>

</tasks>

<verification>
- Both firmware targets compile
- Companion Python parses without errors
- User confirms stats, hotkeys, and media keys work end-to-end
</verification>

<success_criteria>
Phase 3 is complete when: stats header shows live metrics from companion, Hyprland hotkeys fire correctly from all three pages, media keys work via consumer control, and stats header hides cleanly when companion stops.
</success_criteria>

<output>
After completion, create `.planning/phases/03-stats-display-companion-app/03-04-SUMMARY.md`
</output>
