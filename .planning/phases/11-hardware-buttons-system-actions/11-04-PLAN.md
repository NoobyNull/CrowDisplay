---
phase: 11-hardware-buttons-system-actions
plan: 04
type: execute
wave: 3
depends_on: ["11-02", "11-03"]
files_modified:
  - companion/ui/editor_main.py
  - companion/http_client.py
autonomous: true
requirements:
  - HW-SETTINGS-TAB
  - HW-SD-MGMT

must_haves:
  truths:
    - "Settings tab appears alongside page tabs at the top of the editor"
    - "Clock settings section has 12/24h toggle and color theme picker"
    - "Slideshow settings section has interval spinner and transition dropdown"
    - "Power settings section has dim timeout, sleep timeout, and wake-on-touch toggle"
    - "Mode cycle settings section has checkboxes for each mode and drag-reorder for rotation order"
    - "SD card management section shows capacity/usage bar, file listing, and delete buttons"
    - "http_client.py has methods for SD usage, listing, and file deletion via device HTTP API"
  artifacts:
    - path: "companion/ui/editor_main.py"
      provides: "Settings tab with clock, slideshow, power, mode cycle, and SD card sections"
      contains: "SettingsTab"
    - path: "companion/http_client.py"
      provides: "SD card management HTTP methods"
      contains: "sd_usage"
  key_links:
    - from: "companion/ui/editor_main.py"
      to: "companion/http_client.py"
      via: "SD card management calls (usage, list, delete)"
      pattern: "sd_usage|sd_list|sd_delete"
    - from: "companion/ui/editor_main.py"
      to: "companion/config_manager.py"
      via: "display_settings and mode_cycle config read/write"
      pattern: "display_settings|mode_cycle"
---

<objective>
Add the Settings tab to the companion editor with display configuration (clock, slideshow, power, mode cycle) and SD card management interface.

Purpose: Users can configure all display function settings and manage SD card contents from the companion editor.
Output: Settings tab in editor with all configuration sections, HTTP client methods for SD card management.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-hardware-buttons-system-actions/11-RESEARCH.md
@.planning/phases/11-hardware-buttons-system-actions/11-01-SUMMARY.md
@.planning/phases/11-hardware-buttons-system-actions/11-02-SUMMARY.md
@.planning/phases/11-hardware-buttons-system-actions/11-03-SUMMARY.md

@companion/ui/editor_main.py
@companion/http_client.py
@companion/config_manager.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SD card HTTP client methods</name>
  <files>companion/http_client.py</files>
  <action>
In companion/http_client.py, add 3 new methods to the HTTP client class (or as standalone functions matching the existing pattern):

1. **sd_usage(device_ip):**
```python
def sd_usage(self, device_ip: str) -> dict:
    """Get SD card usage stats. Returns {"total_mb": N, "used_mb": N, "free_mb": N}"""
    url = f"http://{device_ip}/api/sd/usage"
    resp = requests.get(url, timeout=5)
    resp.raise_for_status()
    return resp.json()
```

2. **sd_list(device_ip, path="/"):**
```python
def sd_list(self, device_ip: str, path: str = "/") -> dict:
    """List files in SD card directory. Returns {"path": str, "files": [...]}"""
    url = f"http://{device_ip}/api/sd/list"
    resp = requests.get(url, params={"path": path}, timeout=5)
    resp.raise_for_status()
    return resp.json()
```

3. **sd_delete(device_ip, path):**
```python
def sd_delete(self, device_ip: str, path: str) -> dict:
    """Delete a file from SD card. Returns {"success": true}"""
    url = f"http://{device_ip}/api/sd/delete"
    resp = requests.post(url, json={"path": path}, timeout=5)
    resp.raise_for_status()
    return resp.json()
```

Match the existing code style in http_client.py (error handling, logging, method signatures). If the existing client uses a stored device_ip rather than passing it as parameter, follow that pattern instead.
  </action>
  <verify>Run `python -c "from companion.http_client import *; print('SD methods imported')"` -- no import errors</verify>
  <done>http_client has sd_usage(), sd_list(), sd_delete() methods matching device HTTP API</done>
</task>

<task type="auto">
  <name>Task 2: Create Settings tab in editor with display config and SD card management</name>
  <files>companion/ui/editor_main.py</files>
  <action>
Add a "Settings" tab alongside the existing page tabs at the top of the editor. The Settings tab is NOT a page -- it's a separate configuration interface.

Create a SettingsTab class (QWidget) with a QScrollArea containing vertically stacked group boxes:

**1. Clock Settings (QGroupBox "Clock"):**
- "Time Format" radio buttons: 12-hour / 24-hour (maps to display_settings.clock_24h)
- "Clock Color" color picker button showing current color swatch (maps to display_settings.clock_color_theme as 0xRRGGBB)
- Note: analog+digital style is already controlled per-widget in the clock widget type, so no separate setting needed here beyond the global defaults

**2. Slideshow Settings (QGroupBox "Slideshow"):**
- "Interval" QSpinBox: 5-300 seconds, default 30 (maps to display_settings.slideshow_interval_sec)
- "Transition" dropdown: "fade", "slide", "none" (maps to display_settings.slideshow_transition)
- Info label: "Images must be placed in /slideshow/ folder on SD card"

**3. Power Settings (QGroupBox "Power Management"):**
- "Dim Timeout" QSpinBox: 0-600 seconds, default 60 (0 = never dim) (maps to display_settings.dim_timeout_sec)
- "Sleep Timeout" QSpinBox: 0-3600 seconds, default 300 (0 = never sleep) (maps to display_settings.sleep_timeout_sec)
- "Wake on Touch" QCheckBox, default checked (maps to display_settings.wake_on_touch)

**4. Mode Cycle Settings (QGroupBox "Display Mode Rotation"):**
- 4 checkboxes: "Hotkeys", "Clock", "Slideshow", "Standby" -- each maps to a DisplayMode value (0-3)
- Checked modes are included in mode_cycle array
- A QListWidget showing checked modes in order, with "Move Up" / "Move Down" buttons for reordering
- Changes write to config mode_cycle array

**5. SD Card Management (QGroupBox "SD Card"):**
- "Refresh" button to fetch usage and file listing from device
- Usage display: QProgressBar showing used/total with text label (e.g., "156 MB / 7432 MB")
- File tree: QTreeWidget with columns [Name, Size, Type]
  - Load from sd_list() calls -- start with root, expand directories on click
  - Files show size in human-readable format (KB/MB)
- "Delete" button: deletes selected file after confirmation dialog
- Connection status: label showing "Connect to device first" if no device IP, or "Connected to 192.168.4.1" when in config mode
- All SD card operations use the http_client methods from Task 1
- Handle connection errors gracefully (show error in status label, don't crash)

**Integration with editor:**
- Add a "Settings" entry to the page tab bar. It should appear as the last tab with a gear icon or distinct styling.
- When Settings tab is active, the canvas area shows the SettingsTab widget instead of the page canvas.
- When switching back to a page tab, the canvas returns to normal.
- On editor load: populate settings from config dict using get_default_display_settings() and get_default_mode_cycle() as fallbacks.
- On any setting change: update config dict and mark dirty.
- SD card section only works when connected to device in config mode (device_ip available).

Use NoScrollComboBox for all dropdowns. Use standard Qt widgets for everything else.
  </action>
  <verify>Run editor: `python -m companion.crowpanel_editor` -- Settings tab visible, all sections render without errors. Changing settings marks config dirty. SD card section shows "Connect to device first" when not connected.</verify>
  <done>Settings tab with 5 sections (clock, slideshow, power, mode cycle, SD card); all settings read/write config dict; SD card management connects to device via http_client; mode cycle allows reordering; all values persist in config JSON</done>
</task>

</tasks>

<verification>
- Editor launches with Settings tab visible alongside page tabs
- Clock settings: 12/24h toggle and color picker work
- Slideshow settings: interval spinner and transition dropdown work
- Power settings: dim/sleep timeouts and wake-on-touch work
- Mode cycle: checkboxes and reorder work, config updated
- SD card section: shows connection prompt when disconnected
- Config save includes display_settings and mode_cycle sections
- Config load populates settings tab with stored or default values
</verification>

<success_criteria>
- Settings tab is a distinct UI section in the editor
- All 5 configuration sections functional with proper config read/write
- SD card management has usage display, file listing, and delete capability
- Settings persist through config save/load cycles
- No crashes on missing config fields (defaults applied)
</success_criteria>

<output>
After completion, create `.planning/phases/11-hardware-buttons-system-actions/11-04-SUMMARY.md`
</output>
