# Codebase Structure

**Analysis Date:** 2026-02-12

## Directory Layout

```
Elcrow-Display-hotkeys/
├── platformio.ini           # PlatformIO project config (ESP32-S3, board, dependencies)
├── src/                     # Application source code
│   ├── main.cpp             # Entry point, hotkey definitions, UI tree creation
│   ├── main.h               # (implicit) No header; declarations in other headers
│   ├── display_driver.h     # Display hardware abstraction interface
│   ├── display_driver.cpp   # LGFX/LVGL initialization, buffer management, callbacks
│   ├── usb_hid.h            # USB HID interface and Hotkey struct definition
│   ├── usb_hid.cpp          # USB keyboard/media control implementation
│   └── lv_conf.h            # LVGL configuration (fonts, widgets, memory)
├── .pio/                    # PlatformIO build artifacts and library cache
└── .planning/               # GSD planning documents (generated)
    └── codebase/            # Architecture and structure reference docs
```

## Directory Purposes

**src/**
- Purpose: All application source code for the hotkey display firmware
- Contains: C++ files (.cpp/.h), no subdirectories
- Key files: `main.cpp` (application logic), `display_driver.cpp` (hardware), `usb_hid.cpp` (output)

**.pio/**
- Purpose: PlatformIO build system artifacts (do not edit)
- Contains: Compiled object files, downloaded libraries (LovyanGFX, LVGL, Arduino framework)
- Key files: `.pio/libdeps/elcrow_7inch/` contains all dependencies
- Generated: Yes
- Committed: No (in .gitignore)

**.planning/codebase/**
- Purpose: Reference documentation for architecture and structure (generated by GSD)
- Contains: Markdown analysis documents (ARCHITECTURE.md, STRUCTURE.md, CONVENTIONS.md, etc.)
- Generated: Yes
- Committed: No (documentation only, updated per-analysis)

## Key File Locations

**Entry Points:**
- `src/main.cpp`: Arduino setup() and loop() functions; application entry point

**Configuration:**
- `platformio.ini`: Board, framework, build flags, library dependencies, upload speed
- `src/lv_conf.h`: LVGL feature flags, font selection, memory limits, display timings

**Core Logic:**
- `src/main.cpp` lines 38-96: Hotkey definitions (3 pages × 12 hotkeys each)
- `src/main.cpp` lines 107-119: Button event handler (`btn_event_cb()`)
- `src/main.cpp` lines 121-228: UI creation (buttons, tabs, styling)

**Hardware Abstraction:**
- `src/display_driver.h`: Public interface for display init and LVGL tick
- `src/display_driver.cpp`: LGFX RGB panel config, LVGL buffers, touch/flush callbacks
- `src/usb_hid.h`: Hotkey struct definition and modifier key masks
- `src/usb_hid.cpp`: USB keyboard and media control transmission

**Testing:**
- Not applicable (embedded firmware, no test framework)

## Naming Conventions

**Files:**
- Pattern: `lowercase_with_underscore.cpp/h` for module pairs (driver.h, driver.cpp)
- Example: `display_driver.h`, `display_driver.cpp`, `usb_hid.h`, `usb_hid.cpp`

**C++ Classes:**
- Pattern: PascalCase; single LGFX class defined in display_driver.cpp (not exposed in header)
- Example: `LGFX`, `lgfx::Bus_RGB`, `lgfx::Panel_RGB` (from LovyanGFX library)

**Functions:**
- Pattern: lowercase_with_underscores for public and static functions
- Examples: `display_init()`, `lvgl_tick()`, `btn_event_cb()`, `send_hotkey()`, `create_ui()`

**Constants:**
- Pattern: ALL_CAPS for preprocessor macros, mixed case for const structs
- Examples: `#define CLR_RED 0xE74C3C`, `static const HotkeyPage pages[]`

**Modules (Variables):**
- Pattern: lowercase, static scope; global singletons
- Examples: `static LGFX tft` (display_driver.cpp), `static lv_obj_t *tabview` (main.cpp)

**Color Definitions:**
- Pattern: `CLR_<COLOR_NAME>` as hex literals
- Examples: `CLR_BLUE`, `CLR_GREEN`, `CLR_ORANGE` (defined in main.cpp lines 26-35)

**Modifier Masks:**
- Pattern: `MOD_<MODIFIER_NAME>` as bit flags
- Examples: `MOD_CTRL`, `MOD_SHIFT`, `MOD_ALT`, `MOD_GUI`, `MOD_CONSUMER` (in usb_hid.h)

## Where to Add New Code

**New Hotkey (Customize Existing Page):**
- Primary location: `src/main.cpp` within hotkey array definition (e.g., lines 38-51 for page1)
- Syntax: `{"Label", "Description", MOD_CTRL, 'k', CLR_COLOR, LV_SYMBOL_ICON}`
- Automatic: Button created on next build; no other changes needed

**New Hotkey Page:**
- Primary location: `src/main.cpp`
  1. Add static const array after page3 (e.g., `static const Hotkey page4_hotkeys[] = {...}`)
  2. Add HotkeyPage entry in `pages[]` array
  3. Increment `NUM_PAGES` automatically (uses `sizeof(pages)/sizeof(HotkeyPage)`)
- UI creation: No changes needed; `create_ui()` loop (lines 224-227) dynamically creates tabs

**New Hardware Feature (E.g., Button, LED):**
- Primary location: `src/display_driver.cpp` (if display/touch related) or create new `feature_driver.cpp/h`
- Pattern: Define hardware class/config in .cpp, expose init function in .h
- Integration: Call init from `setup()` in main.cpp

**New USB Output Type (E.g., Mouse, Joystick):**
- Primary location: Extend `src/usb_hid.cpp` with new function (e.g., `send_mouse_move()`)
- Modify Hotkey struct in `usb_hid.h` if new output type requires new fields
- Or create new module `usb_mouse.h/cpp` following same pattern as usb_hid

**Shared Utilities:**
- Location: Create `src/utils.h` for header-only utilities, or `src/utils.cpp/h` for compiled utilities
- Example: Color conversion, font selection helpers

## Special Directories

**.pio/ (PlatformIO Cache):**
- Purpose: Build artifacts and dependency cache
- Generated: Yes (by PlatformIO build system)
- Committed: No (excluded via .gitignore)
- Safe to delete: Yes (rebuilt on next compile)
- Contains: Libraries, object files, build outputs

**src/ (Source Code):**
- Purpose: Application firmware
- Generated: No (manually edited)
- Committed: Yes
- Safe to delete: No

## File Dependencies (Dependency Graph)

**main.cpp** depends on:
- `Arduino.h` (Arduino framework)
- `Wire.h` (I2C library)
- `lvgl.h` (LVGL core)
- `display_driver.h` (local module)
- `usb_hid.h` (local module)

**display_driver.cpp** depends on:
- `Arduino.h`
- `LovyanGFX.hpp` (external library)
- `lgfx/v1/platforms/esp32s3/Panel_RGB.hpp` (LovyanGFX platform-specific)
- `driver/i2c.h` (ESP32 I2C HAL)
- `lvgl.h`
- `display_driver.h` (own interface)

**usb_hid.cpp** depends on:
- `Arduino.h`
- `USB.h` (ESP32-S3 native USB)
- `USBHIDKeyboard.h` (Arduino USB library)
- `USBHIDConsumerControl.h` (Arduino USB library)
- `usb_hid.h` (own interface)

**lv_conf.h** is included by LVGL; no dependencies, pure configuration.

## Build & Compilation

**Build System:** PlatformIO (platformio.ini controls all settings)

**Compile Command:**
```bash
pio run -e elcrow_7inch          # Build for elcrow_7inch environment
pio run -e elcrow_7inch -t upload # Build and upload via JTAG/Serial
pio run -e elcrow_7inch -t monitor # Open serial monitor (115200 baud)
```

**Build Flags** (from platformio.ini):
- `-DARDUINO_USB_MODE=0` - Enable USB OTG (required for HID)
- `-DARDUINO_USB_CDC_ON_BOOT=1` - Serial over USB
- `-DBOARD_HAS_PSRAM` - Enable PSRAM use
- `-DLV_CONF_INCLUDE_SIMPLE` - LVGL uses simple include path for lv_conf.h
- `-I src` - Add src/ to include path

**Memory Model:**
- FLASH: 4MB (board_upload.flash_size)
- PSRAM: Available via `ps_malloc()` (LVGL buffers, UI objects allocated here)
- Internal RAM: Arduino framework + stack

---

*Structure analysis: 2026-02-12*
